<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Why don&#x27;t I get the throughput I benchmarked?</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Open+Sans:400italic,700italic,700,400">
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/roon/assets/css/screen.css?v=1536077092420" />

    <link rel="canonical" href="https://vanilla-java.github.io/2016/07/23/Why-dont-I-get-the-throughput-I-benchmarked.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Why don&#x27;t I get the throughput I benchmarked?" />
    <meta property="og:description" content="In synthetic benchmarks, you can achieve a high throughput for your system by throwing lots of independant tasks/clients at it to see what the theoretical limit of your system is, however in real world situations, the throughput you achieve is often much, much lower.  One of of the explanations" />
    <meta property="og:url" content="https://vanilla-java.github.io/2016/07/23/Why-dont-I-get-the-throughput-I-benchmarked.html" />
    <meta property="article:published_time" content="2016-07-23T00:00:00.000Z" />
    <meta property="article:tag" content="Performance" />
    <meta property="article:tag" content="Low Latency" />
    <meta property="article:tag" content="Benchmarking" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Why don&#x27;t I get the throughput I benchmarked?" />
    <meta name="twitter:description" content="In synthetic benchmarks, you can achieve a high throughput for your system by throwing lots of independant tasks/clients at it to see what the theoretical limit of your system is, however in real world situations, the throughput you achieve is often much, much lower.  One of of the explanations" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2016/07/23/Why-dont-I-get-the-throughput-I-benchmarked.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Why don&#x27;t I get the throughput I benchmarked?",
    "url": "https://vanilla-java.github.io/2016/07/23/Why-dont-I-get-the-throughput-I-benchmarked.html",
    "datePublished": "2016-07-23T00:00:00.000Z",
    "keywords": "Performance, Low Latency, Benchmarking",
    "description": "In synthetic benchmarks, you can achieve a high throughput for your system by throwing lots of independant tasks/clients at it to see what the theoretical limit of your system is, however in real world situations, the throughput you achieve is often much, much lower.  One of of the explanations"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Performance tag-Low-Latency tag-Benchmarking  noimage">

    


    <article role="main" class="">
        <header>
            <a href="https://vanilla-java.github.io" id="home_link">«</a>
            <div class="meta"><time datetime="2016-07-23"><a href="/">July 23, 2016</a></time> <span class="count" id="js-reading-time"></span></div>
            <h1>Why don&#x27;t I get the throughput I benchmarked?</h1>
        </header>

        <div class="text" id="js-post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In synthetic benchmarks, you can achieve a high throughput for your system by throwing lots of independant tasks/clients at it to see what the theoretical limit of your system is, however in real world situations, the throughput you achieve is often much, much lower.  One of of the explanations for this comes from <a href="https://en.wikipedia.org/wiki/Little%27s_law">Little&#8217;s Law</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_little_s_law">What is Little&#8217;s Law?</h3>
<div class="paragraph">
<p>This law comes from queuing theory, an example being the number of  <a href="https://en.wikipedia.org/wiki/Little%27s_law#Customers_In_The_Store">customers in a store</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Little's Law tells us that the average number of customers in the store L, is the effective arrival rate λ, times the average time that a customer spends in the store W</pre>
</div>
</div>
<div class="paragraph">
<p><strong class="big">L=&lambda; &times; W</strong></p>
</div>
<div class="paragraph">
<p>For a given latency, the higher the throughput you need to achieve, the higher the number of independant tasks you need. Say you have a shop where checking out at an automatic till takes 10 minutes on average. To achieve, a given throughput, how many tills, and people wanting to check out do you need?</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throughput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">People trying to check out at once</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 every 10 minutes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 person and 1 till</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 per minute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 people and 10 tills</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 per minute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 people and 100 tills</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There might not be 10 or 100 people trying to check out at once, so even if you have the tills, there might not be enough people/users to utlise the tills you have.</p>
</div>
<div class="paragraph">
<p>Say instead it only takes 1 minute to pass through a till, how many people do you need to be checking out at once to get the throughput you are looking for.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throughput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">People trying to check out at once</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 every 10 minutes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 person and 1 till</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 per minute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 person and 1 till</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 per minute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 people and 10 tills</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Reducing the latency by a factor of 10 means you need one tenth of the resources. More importantly, you only need one tenth of the people trying to check out/tasks to achieve the desired throughput.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some problems have inherent limits to the number of independant tasks you have. Trading systems and business applications might only have an intrinsic concurrency of between 1 and 10, in which case, latency rather than throughput is your main constraint.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_chronicle_queue_vs_apache_kafka">Chronicle Queue vs Apache Kafka</h3>
<div class="paragraph">
<p>On the surface, Chronicle Queue and Apache Kafka do many of the same things.  They are both high throughput, persisted queues.  What difference do Chronicle&#8217;s much lower latencies make?</p>
</div>
<div class="paragraph">
<p>In this benchmark, <a href="https://engineering.linkedin.com/kafka/benchmarking-apache-kafka-2-million-writes-second-three-cheap-machines">Apache Kafka</a> achieved a throughput of around 400,000/s - 800,000/s on one machine, with linear scalability to three machines. This is a very good throughput.  However the latency measured 2 ms and the 99%ile was 3 ms.  This means any individual task which must wait for replication before proceeding must wait around 2 milli-seconds, or more conservatively 3 milli-seconds.</p>
</div>
<div class="paragraph">
<p>If the latency is 3 milli-seconds, how many independant tasks do you need to have to reach a desired throughput?</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://vanilla-java.github.io/images/Chronicle-vs-Kafka-Concurrency.png" alt="Chronicle vs Kafka Concurrency"></span></p>
</div>
<div class="paragraph">
<p>To achieve higher throughputs, you need more independant tasks. What if you only have 1 to 100 independant tasks?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/Chronicle-vs-Kafka-Concurrency-Scaled.png" alt="Chronicle vs Kafka Concurrency Scaled">
</div>
</div>
<div class="paragraph">
<p>With a small set of tasks, you are not going to achieve a high throughput with a latency of 3 ms.  By comparison if we look at the 99%ile latency of Chroncile Queue synchronous replication, which is between <a href="https://vanilla-java.github.io/2016/07/20/Latency-for-a-set-Throughput.html">20 - 40 micro-seconds</a>, you can achieve high throughputs with relatively few independant tasks.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Independant Task(s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chronicle Queue Throughput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache Kafka Throughput</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50,000 per second</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">340 per second</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">290,000 per second</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3,400 per second</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2,000,000 per second (2 servers)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">34,000 per second</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To achieve, the benchmark throughput with Kafka, you need a problem which has a very high number of independant tasks (many thousands), or you either need asynchronous replication.</p>
</div>
<div class="paragraph">
<p>If asynchronous replication is acceptable, then Chronicle Queue has a much lower latency of 1.2 micro-seconds for the 99%ile.  This means it can support close to one million messages per second with a single thread and only one task at a time. Two threads are enough to get 80 million events per minute which is our benchmark throughput for the E5-2650 v2 server we tested.</p>
</div>
</div>
<div class="sect1">
<h2 id="_when_do_i_add_monitoring_to_my_application">When do I add monitoring to my application?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Kafka was designed for web application monitoring.  It is widely used for this purpose today. As such it does the job very well.</p>
</div>
<div class="paragraph">
<p>However, Chronicle Queue is design to be fast enough to be part of the critical path, recording all the inputs and outputs of your services. Since you are already recording all the data needed to recreate the state of your component at any point, little additional monitoring is required. (System monitoring is still required)  It is not a case of; Now our application is in production, how do we monitor it? Or how do we replay message to recreate an issue?</p>
</div>
<div class="paragraph">
<p>Chronicle Queue is integral to the working of the application so you know no information is missing or the application wouldn&#8217;t work.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have a problem with many thousands of independant tasks, then high number of tasks "in flight", or customers in the store, is a relatively simple way to get the throughput you need and the impact of latency is low.  If you have a few tasks, or just one task you can perform at a given moment, latency rather than throughput is critical.</p>
</div>
</div>
</div>
        </div>

        <menu>
            <a href="" id="btn_share" class="btn" title="Share">
                <span aria-hidden="true" data-icon="S"></span>
                <strong>Share</strong>
            </a>
            <a href="http://twitter.com/share?text=Why%20don't%20I%20get%20the%20throughput%20I%20benchmarked%3F&url=https://vanilla-java.github.io/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" id="btn_comment" class="btn" target="_blank">
                <span aria-hidden="true" data-icon="C"></span> Comment on Twitter
            </a>
        </menu>


        <footer class="post-footer" role="contentinfo">

            <div class="vcard">
                <a href="https://vanilla-java.github.io/rss" id="btn_feed" class="btn" title="Feed" target="_blank">
                    <span aria-hidden="true" data-icon=")"></span>
                    <strong>Feed</strong>
                </a>

                <a href="https://vanilla-java.github.io/author/peter-lawrey/" class="photo">
                    <span style="background-image: url('https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4');">
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4" alt="Peter Lawrey">
                    </span>
                </a>

                <div class="details">
                    <h4><a href="https://vanilla-java.github.io/author/peter-lawrey/" class="url n">Peter Lawrey</a></h4>
                    London<br>
                    <a href="http://vanillajava.blogspot.com/" class="js-remove-domain-schema">http://vanillajava.blogspot.com/</a>
                </div>
            </div>

            <div id="user_bio">
                <div class="inner">
                    Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion
                </div>
            </div>

        </footer>




    <section class="post-comments">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
      var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>


    </article>

    <div id="share_modal">
        <div class="wrap">
            <div class="inner">
                <header>
                    Share
                    <a href="" class="close" title="Close">&times;</a>
                </header>

                <div class="roon-share-links">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    <div id="fb-elems">
                        <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) return;
                        js = d.createElement(s); js.id = id;
                        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=463438580397968";
                        fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));</script>
                        <div class="fb-like" data-send="false" data-layout="button_count" data-width="110" data-show-faces="false" data-font="arial"></div>
                    </div>

                    <div id="pinit-btn">
                        <a href="//pinterest.com/pin/create/button/?url=https://vanilla-java.github.io/&amp;description=Why%20don't%20I%20get%20the%20throughput%20I%20benchmarked%3F-Vanilla%20Java " data-pin-do="buttonPin" data-pin-config="beside"><img src="//assets.pinterest.com/images/pidgets/pin_it_button.png"></a>
                        <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>




        <a href="https://vanilla-java.github.io" id="blog_badge">
            <span style="background-image: url('https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg');">Vanilla Java</span>
        </a>


    <script>

            function get_text(el) {
                ret = "";
                var length = el.childNodes.length;
                for(var i = 0; i < length; i++) {
                    var node = el.childNodes[i];
                    if(node.nodeType != 8) {
                        ret += node.nodeType != 1 ? node.nodeValue : get_text(node);
                    }
                }
                return ret;
            }
            function reading_time () {
                var post_content = document.getElementById('js-post-content');
                if (post_content) {
                    var words = get_text(post_content),
                        count = words.split(/\s+/).length,
                        read_time = Math.ceil((count / 150)),
                        read_time_node = document.createTextNode(read_time + ' min read');
                    document.getElementById('js-reading-time').appendChild(read_time_node);
                }
            }

        function no_schema_links () {
            var links = document.querySelectorAll('.js-remove-domain-schema');
            if (links) {
                for (i = 0; i < links.length; ++i) {
                    var link = links[i],
                        text = link.innerHTML,
                        no_schema = text.replace(/.*?:\/\//g, "");
                    link.innerHTML = no_schema;
                }
            }
        }

        window.onload = function () {
            no_schema_links();

            reading_time();
        }
    </script>


    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

        <script>
            $(function(){
                var share_modal = $("#share_modal"),
                    update_social_links = true;

                $("#btn_share").click(function(){
                    var that = $(this);
                    share_modal.fadeIn(200);
                    return false;
                });

                share_modal.click(function(e){
                    if (e.target.className == "wrap" || e.target.id == "share_modal") {
                        share_modal.fadeOut(200);
                    }
                    return false;
                });

                share_modal.find("div.inner > header > a.close").click(function(){
                    share_modal.fadeOut(200);
                    return false;
                });
            });
        </script>


    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>

</body>
</html>
