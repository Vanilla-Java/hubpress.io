<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Microservices in the Chronicle World - Part 5</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Open+Sans:400italic,700italic,700,400">
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/roon/assets/css/screen.css?v=1536077092895" />

    <link rel="canonical" href="https://vanilla-java.github.io/2016/04/02/Microservices-in-the-Chronicle-World-Part-5.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Microservices in the Chronicle World - Part 5" />
    <meta property="og:description" content="In this part we look at putting a micro service together as a collection of services, and consider how we can evaluate the performance of these services.  We introduce JLBH (Java Latency Benchmark Harness) to test these services. Building a Service Wrapper. For more complex services, we use an EventLoop" />
    <meta property="og:url" content="https://vanilla-java.github.io/2016/04/02/Microservices-in-the-Chronicle-World-Part-5.html" />
    <meta property="article:published_time" content="2016-04-02T00:00:00.000Z" />
    <meta property="article:tag" content="Microservices" />
    <meta property="article:tag" content="latency profile" />
    <meta property="article:tag" content="JLBH" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Microservices in the Chronicle World - Part 5" />
    <meta name="twitter:description" content="In this part we look at putting a micro service together as a collection of services, and consider how we can evaluate the performance of these services.  We introduce JLBH (Java Latency Benchmark Harness) to test these services. Building a Service Wrapper. For more complex services, we use an EventLoop" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2016/04/02/Microservices-in-the-Chronicle-World-Part-5.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Microservices in the Chronicle World - Part 5",
    "url": "https://vanilla-java.github.io/2016/04/02/Microservices-in-the-Chronicle-World-Part-5.html",
    "datePublished": "2016-04-02T00:00:00.000Z",
    "keywords": "Microservices, latency profile, JLBH",
    "description": "In this part we look at putting a micro service together as a collection of services, and consider how we can evaluate the performance of these services.  We introduce JLBH (Java Latency Benchmark Harness) to test these services. Building a Service Wrapper. For more complex services, we use an EventLoop"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Microservices tag-latency-profile tag-JLBH  noimage">

    


    <article role="main" class="">
        <header>
            <a href="https://vanilla-java.github.io" id="home_link">Â«</a>
            <div class="meta"><time datetime="2016-04-02"><a href="/">April 02, 2016</a></time> <span class="count" id="js-reading-time"></span></div>
            <h1>Microservices in the Chronicle World - Part 5</h1>
        </header>

        <div class="text" id="js-post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this part we look at putting a micro service together as a collection of services, and consider how we can evaluate the performance of these services.  We introduce JLBH (Java Latency Benchmark Harness) to test these services.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_a_service_wrapper">Building a Service Wrapper.</h3>
<div class="paragraph">
<p>For more complex services, we use an EventLoop in Chronicle Threads to manage multiple concurrent tasks. In this example we have only one task, so it is simpler to have a custom class to support it.</p>
</div>
<div class="paragraph">
<p>This class is available at <a href="https://github.com/Vanilla-Java/Microservices/blob/master/src/main/java/net/openhft/samples/microservices/ServiceWrapper.java">ServiceWrapper</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class ServiceWrapper&lt;I extends ServiceHandler&gt; implements Runnable, Closeable {
    private final ChronicleQueue inputQueue, outputQueue;
    private final MethodReader serviceIn;
    private final Object serviceOut;
    private final Thread thread;
    private final Pauser pauser = new LongPauser(1, 100, 500, 10_000, TimeUnit.MICROSECONDS); <i class="conum" data-value="1"></i><b>(1)</b>

    private volatile boolean closed = false;

    public ServiceWrapper(String inputPath, String outputPath, I serviceImpl) {
        Class outClass = ObjectUtils.getTypeFor(serviceImpl.getClass(), ServiceHandler.class); <i class="conum" data-value="2"></i><b>(2)</b>

        outputQueue = SingleChronicleQueueBuilder.binary(outputPath).build(); <i class="conum" data-value="3"></i><b>(3)</b>
        serviceOut = outputQueue.createAppender().methodWriter(outClass);
        serviceImpl.init(serviceOut); <i class="conum" data-value="4"></i><b>(4)</b>

        inputQueue = SingleChronicleQueueBuilder.binary(inputPath).build();
        serviceIn = inputQueue.createTailer().methodReader(serviceImpl); <i class="conum" data-value="5"></i><b>(5)</b>

        thread = new Thread(this, new File(inputPath).getName() + " to " + new File(outputPath).getName());
        thread.setDaemon(true);
        thread.start(); <i class="conum" data-value="6"></i><b>(6)</b>
    }

    @Override
    public void run() {
        AffinityLock lock = AffinityLock.acquireLock(); <i class="conum" data-value="7"></i><b>(7)</b>
        try {
            while (!closed) {
                if (serviceIn.readOne()) { <i class="conum" data-value="8"></i><b>(8)</b>
                    pauser.reset(); <i class="conum" data-value="9"></i><b>(9)</b>
                } else {
                    pauser.pause(); <i class="conum" data-value="9"></i><b>(9)</b>
                }
            }
        } finally {
            lock.release();
        }
    }

    @Override
    public void close() {
        closed = true;
    }

    @Override
    public boolean isClosed() {
        return closed;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This Pauser controls the back off strategy in which no events are coming through. It will retry once, yield 100 times, then start sleeping from half a millisecond to 10 milliseconds.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtain the type of the parameter for the <code>ServiceHandler</code> and in this case it is a <code>Service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an output queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And pass it to the implementation so it can write to it&#8217;s output queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Create a reader for the input queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Start a thread which will read from the <code>serviceIn</code> reader.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Bind this thread to an isolated CPU where possible.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Read and process one message.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><code>reset()</code> the pauser if a message came, otherwise call it for a possible pause.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_timing_our_service">Timing our service.</h3>
<div class="paragraph">
<p>A simple service can time itself. This could be implmented as a wrapper, however for a more complex service you can use the builing in history recording and only examine the result at the end.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class ServiceImpl implements Service, ServiceHandler&lt;Service&gt; {
    private final NanoSampler nanoSampler;
    private final NanoSampler endToEnd;
    private Service output;

    public ServiceImpl(NanoSampler nanoSampler) {
        this(nanoSampler, t -&gt; {
        });
    }

    public ServiceImpl(NanoSampler nanoSampler, NanoSampler endToEnd) {
        this.nanoSampler = nanoSampler;
        this.endToEnd = endToEnd;
    }

    @Override
    public void init(Service output) {
        this.output = output;
    }

    @Override
    public void simpleCall(SimpleData data) {
        data.number *= 10; // do something.

        long time = System.nanoTime();
        nanoSampler.sampleNanos(time - data.ts); <i class="conum" data-value="1"></i><b>(1)</b>
        data.ts = time; // the start time for the next stage.

        output.simpleCall(data); // pass the data to the next stage.

        endToEnd.sampleNanos(System.nanoTime() - data.ts0); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Take the timing since the last stage</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Take the timing from the start</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_jlbh_java_latency_benchamrk_harness">Using JLBH Java Latency Benchamrk Harness</h3>
<div class="paragraph">
<p>This tool is based on JMH (Java Microbenchmark Harness) where the main difference is support for testing asynchronous processes where you want to examine the timings at different stages, possibly in different theads.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">JLBHOptions jlbhOptions = new JLBHOptions()
        .warmUpIterations(50_000)
        .iterations(MESSAGE_COUNT)
        .throughput(THROUGHPUT) <i class="conum" data-value="1"></i><b>(1)</b>
        .runs(6)
        .recordOSJitter(true) <i class="conum" data-value="2"></i><b>(2)</b>
        .pauseAfterWarmupMS(500)
        .accountForCoordinatedOmmission(ACCOUNT_FOR_COORDINATED_OMMISSION) <i class="conum" data-value="3"></i><b>(3)</b>
        .jlbhTask(new MultiThreadedMainTask());
new JLBH(jlbhOptions).start();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Benchmark for a target throughput.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add a thread to record the OS jitter over the interval.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Turn on correction for coordinated ommission.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To set up the test, we create three services. This models a gateway which accepting data from external systems such as aweb service or FIX Engine.  This is picked up by one service, which passes a message to a second service and finally this is written to a gateway service which can pass the data to an external system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">UUID uuid = UUID.randomUUID();
String queueIn = OS.TMP + "/MultiThreadedMain/" + uuid + "/pathIn";
String queue2 = OS.TMP + "/MultiThreadedMain/" + uuid + "/stage2";
String queue3 = OS.TMP + "/MultiThreadedMain/" + uuid + "/stage3";
String queueOut = OS.TMP + "/MultiThreadedMain/" + uuid + "/pathOut";

@Override
public void init(JLBH jlbh) {
    serviceIn = SingleChronicleQueueBuilder.binary(queueIn).build().createAppender().methodWriter(Service.class); <i class="conum" data-value="1"></i><b>(1)</b>
    service2 = new ServiceWrapper&lt;&gt;(queueIn, queue2, new ServiceImpl(jlbh.addProbe("Service 2"))); <i class="conum" data-value="2"></i><b>(2)</b>
    service3 = new ServiceWrapper&lt;&gt;(queue2, queue3, new ServiceImpl(jlbh.addProbe("Service 3"))); <i class="conum" data-value="3"></i><b>(3)</b>
    serviceOut = new ServiceWrapper&lt;&gt;(queue3, queueOut, new ServiceImpl(jlbh.addProbe("Service Out"), jlbh)); <i class="conum" data-value="4"></i><b>(4)</b> <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Just a writer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Reads that message and writes to the third service</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reads from the second service and writes to the outbound service.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The output gateway reads from the third service and writes its result to a log/queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The last service also sets the end to end timing.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Every message is being persisted at each stage and is available on restart. As there is one output message for every input pmessage you could restart by winding to the same index as the output. A more robust strategy would be to record te history in the output as covered in the previous post.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_tests">Running the tests</h3>
<div class="paragraph">
<p>There are two important considerations when running performance tests</p>
</div>
<div class="ulist">
<ul>
<li>
<p>what is the percentile that you care about?</p>
<div class="ulist">
<ul>
<li>
<p>Typical,</p>
</li>
<li>
<p>99%tile (worst 1 in 100)</p>
</li>
<li>
<p>99.9%tile (worst 1 in 1000)</p>
</li>
<li>
<p>99.99%tile ( worst 1 in 10000)</p>
</li>
<li>
<p>worst, ever</p>
</li>
</ul>
</div>
</li>
<li>
<p>what is the throughput you are looking to test.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is important that you control the throughput for the test so you can see how your system behaves at different sustained throuhgputs.  You system will run as fast as possible for short periods, however buffers and caches quickly fill up and cannot support this rate without getting large delays.</p>
</div>
</div>
<div class="sect2">
<h3 id="_looking_at_the_typical_performance">Looking at the typical performance.</h3>
<div class="paragraph">
<p>In this test on a E5-2650 v2, the throughput it can achieve for this test is 600,000 messages/second.  However, it wouldn&#8217;t be practical to do this for any long period of time as the system quickly gets to the point where it is behind with increasing delay the long this goes on.  This is because there is no head room to deal with any jitter or delay in the system. Every delay accumulates as the system struggle to keeps up. So what is a more practical throughput for this mock system.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="https://vanilla-java.github.io/images/mtm-typical-vs-rate.png" alt="mtm typical vs rate">
</div>
<div class="title">Figure 1. Worst Typical was the highest of 15, 2 minute runs.</div>
</div>
<div class="paragraph">
<p>This looks fine, for all the throughputs up to 400,000 messages per second, the typical performance is consistent.  However, for a throughput of 450,000 messages per second, the service could get a delay which it would struggle to recover from and the typical latency would jump to 20 - 40 seconds.</p>
</div>
<div class="paragraph">
<p>In short, by looking at the typical performance our estimate of throughput we might prefer has dropped from 600K/s to 400K/s</p>
</div>
</div>
<div class="sect2">
<h3 id="_looking_at_the_nines">Looking at the nines.</h3>
<div class="paragraph">
<p>By looking at the higher percentiles (worst results) we can for a view as to what delays would be acceptable and how often.  Typically, I would consider a 99%tile which 4x the typical and a 99.9%tile which 10x the typical latency.  This is rule of thumb I use, however the results vary between systems.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="https://vanilla-java.github.io/images/mtm-99-vs-rate.png" alt="mtm 99 vs rate">
</div>
<div class="title">Figure 2. The worst 1 in 100 gets higher as the throughput increases.</div>
</div>
<div class="paragraph">
<p>You might take the view that the 99%tile should be under 10 micro-seconds, and conclude the system can handle 300K messages/second.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="https://vanilla-java.github.io/images/mtm-999-vs-rate.png" alt="mtm 999 vs rate">
</div>
<div class="title">Figure 3. The worst 1 in 1000 gets higher as the throughput increases.</div>
</div>
<div class="paragraph">
<p>Looking at the 99.9%tile you can see that above 200K msg/second our latencies shoot up.  Up to 200 K/s our system has very stable latencies.</p>
</div>
</div>
<div class="sect2">
<h3 id="_can_we_sustain_200_k_msg_second">Can we sustain 200 K msg/second?</h3>
<div class="paragraph">
<p>The problem arises that we will not want to sustain this rate for long.  Bursts are fine, but do this all day long and you generate a lot of data. If all the messages are recorded and they total say 1/2 KB for each inbound message, this will be producing 200 MB/s, and while an SSD can do this easily it will run out of space pretty fast. 200 MB/s is 9 TB per day. Nine TB of usable high performance SSD is still pretty pricy.</p>
</div>
<div class="paragraph">
<p>Lets say we wanted to record less than 2 TB per day.  A few high capacity HDD could persist all your messages for a week. This is 23 MB/s sustained. At 512 bytes per message (total) you are looking at a more modest 50K message/second sustained, but with burst of up to 200K/s - 600K/s depending on your requirements.</p>
</div>
</div>
<div class="sect2">
<h3 id="_in_summary">In summary</h3>
<div class="paragraph">
<p>We have a test harness for multi-threaded asynchronous processes and it can help you explore how your service might behave under various throughput loads.  While your system might be able to support high throughputs for very short periods of time, how sustained throughput impacts the latency of your system.</p>
</div>
</div>
        </div>

        <menu>
            <a href="" id="btn_share" class="btn" title="Share">
                <span aria-hidden="true" data-icon="S"></span>
                <strong>Share</strong>
            </a>
            <a href="http://twitter.com/share?text=Microservices%20in%20the%20Chronicle%20World%20-%20Part%205&url=https://vanilla-java.github.io/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" id="btn_comment" class="btn" target="_blank">
                <span aria-hidden="true" data-icon="C"></span> Comment on Twitter
            </a>
        </menu>


        <footer class="post-footer" role="contentinfo">

            <div class="vcard">
                <a href="https://vanilla-java.github.io/rss" id="btn_feed" class="btn" title="Feed" target="_blank">
                    <span aria-hidden="true" data-icon=")"></span>
                    <strong>Feed</strong>
                </a>

                <a href="https://vanilla-java.github.io/author/peter-lawrey/" class="photo">
                    <span style="background-image: url('https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4');">
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4" alt="Peter Lawrey">
                    </span>
                </a>

                <div class="details">
                    <h4><a href="https://vanilla-java.github.io/author/peter-lawrey/" class="url n">Peter Lawrey</a></h4>
                    London<br>
                    <a href="http://vanillajava.blogspot.com/" class="js-remove-domain-schema">http://vanillajava.blogspot.com/</a>
                </div>
            </div>

            <div id="user_bio">
                <div class="inner">
                    Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion
                </div>
            </div>

        </footer>




    <section class="post-comments">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
      var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>


    </article>

    <div id="share_modal">
        <div class="wrap">
            <div class="inner">
                <header>
                    Share
                    <a href="" class="close" title="Close">&times;</a>
                </header>

                <div class="roon-share-links">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    <div id="fb-elems">
                        <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) return;
                        js = d.createElement(s); js.id = id;
                        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=463438580397968";
                        fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));</script>
                        <div class="fb-like" data-send="false" data-layout="button_count" data-width="110" data-show-faces="false" data-font="arial"></div>
                    </div>

                    <div id="pinit-btn">
                        <a href="//pinterest.com/pin/create/button/?url=https://vanilla-java.github.io/&amp;description=Microservices%20in%20the%20Chronicle%20World%20-%20Part%205-Vanilla%20Java " data-pin-do="buttonPin" data-pin-config="beside"><img src="//assets.pinterest.com/images/pidgets/pin_it_button.png"></a>
                        <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>




        <a href="https://vanilla-java.github.io" id="blog_badge">
            <span style="background-image: url('https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg');">Vanilla Java</span>
        </a>


    <script>

            function get_text(el) {
                ret = "";
                var length = el.childNodes.length;
                for(var i = 0; i < length; i++) {
                    var node = el.childNodes[i];
                    if(node.nodeType != 8) {
                        ret += node.nodeType != 1 ? node.nodeValue : get_text(node);
                    }
                }
                return ret;
            }
            function reading_time () {
                var post_content = document.getElementById('js-post-content');
                if (post_content) {
                    var words = get_text(post_content),
                        count = words.split(/\s+/).length,
                        read_time = Math.ceil((count / 150)),
                        read_time_node = document.createTextNode(read_time + ' min read');
                    document.getElementById('js-reading-time').appendChild(read_time_node);
                }
            }

        function no_schema_links () {
            var links = document.querySelectorAll('.js-remove-domain-schema');
            if (links) {
                for (i = 0; i < links.length; ++i) {
                    var link = links[i],
                        text = link.innerHTML,
                        no_schema = text.replace(/.*?:\/\//g, "");
                    link.innerHTML = no_schema;
                }
            }
        }

        window.onload = function () {
            no_schema_links();

            reading_time();
        }
    </script>


    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

        <script>
            $(function(){
                var share_modal = $("#share_modal"),
                    update_social_links = true;

                $("#btn_share").click(function(){
                    var that = $(this);
                    share_modal.fadeIn(200);
                    return false;
                });

                share_modal.click(function(e){
                    if (e.target.className == "wrap" || e.target.id == "share_modal") {
                        share_modal.fadeOut(200);
                    }
                    return false;
                });

                share_modal.find("div.inner > header > a.close").click(function(){
                    share_modal.fadeOut(200);
                    return false;
                });
            });
        </script>


    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>

</body>
</html>
