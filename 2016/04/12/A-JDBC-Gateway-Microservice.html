<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>A JDBC Gateway Microservice</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/fastclick.js?v=1536077025213"></script>
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/modernizr.js?v=1536077025213"></script>


    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/normalize.css?v=1536077025213" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/foundation.min.css?v=1536077025213" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/outdatedBrowser.min.css?v=1536077025213">
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/fonts/foundation-icons/foundation-icons.css?v=1536077025213" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/styles.css?v=1536077025213" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300,700,400|Source+Sans+Pro:300,400,600,700,900,300italic,400italic,600italic,700italic,900italic" />

    <link rel="canonical" href="https://vanilla-java.github.io/2016/04/12/A-JDBC-Gateway-Microservice.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="A JDBC Gateway Microservice" />
    <meta property="og:description" content="A deep dive into a low latency microservice We look at a microservice which can run in it&amp;#8217;s own JVM, can perform JDBC updates and queries via a persistent queue for in bound request and a queue for results. In previous posts I looked at the theory behind" />
    <meta property="og:url" content="https://vanilla-java.github.io/2016/04/12/A-JDBC-Gateway-Microservice.html" />
    <meta property="article:published_time" content="2016-04-12T00:00:00.000Z" />
    <meta property="article:tag" content="Microservices" />
    <meta property="article:tag" content="JDBC" />
    <meta property="article:tag" content="Example" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="A JDBC Gateway Microservice" />
    <meta name="twitter:description" content="A deep dive into a low latency microservice We look at a microservice which can run in it&amp;#8217;s own JVM, can perform JDBC updates and queries via a persistent queue for in bound request and a queue for results. In previous posts I looked at the theory behind" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2016/04/12/A-JDBC-Gateway-Microservice.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "A JDBC Gateway Microservice",
    "url": "https://vanilla-java.github.io/2016/04/12/A-JDBC-Gateway-Microservice.html",
    "datePublished": "2016-04-12T00:00:00.000Z",
    "keywords": "Microservices, JDBC, Example",
    "description": "A deep dive into a low latency microservice We look at a microservice which can run in it&amp;#8217;s own JVM, can perform JDBC updates and queries via a persistent queue for in bound request and a queue for results. In previous posts I looked at the theory behind"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Microservices tag-JDBC tag-Example">

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdate" href="http://outdatedbrowser.com/">Update my browser now</a></p>
</div>

<nav class="top-bar hide-for-large-up" data-topbar style="background: none">
  <ul class="title-area">
    <li class="name">

    </li>
    <li class="home"><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
    <li class="toggle-topbar"><a href="#" id="trigger-overlay" class="fi-list"></a></li>
  </ul>

<div class="overlay overlay-scale">
    <button type="button" class="overlay-close">Close</button>
    <nav>
        <ul>
            <li><a href="https://vanilla-java.github.io">Home</a></li>
        </ul>
    </nav>
</div>

</nav>

<div class="row">

<div class="small-16 medium-16 large-4 columns right head-area bgimage" style="background-image: url(https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg)">

<header class="site-head">
    <div class="vertical">
        <div class="site-head-content inner">
            <ul class="side-nav blog-menu show-for-large-up">
                <li><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
                <li><a class="fi-torso" href="https://vanilla-java.github.io/about"></a></li>
                <li><a class="fi-mail" href="https://vanilla-java.github.io/contact"></a></li>
            </ul>
            <a class="blog-logo" href="https://vanilla-java.github.io"><img alt="Vanilla Java" src="https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg" alt="Blog Logo" /></a>
            <h1 class="blog-title">Vanilla Java</h1>
            <hr>
            <p class="blog-description"></p>
            <div class="blog-network">
<!--                 <a href="#" class="fi-social-pinterest"></a>
                <a href="#" class="fi-social-linkedin"></a>
                <a href="#" class="fi-social-behance"></a>
                <a href="#" class="fi-social-deviant-art"></a>
                <a href="#" class="fi-social-dribbble"></a>
                <a href="#" class="fi-social-flickr"></a>
                <a href="#" class="fi-social-github"></a>
                <a href="#" class="fi-social-skype"></a>
                <a href="#" class="fi-social-snapchat"></a>
                <a href="#" class="fi-social-steam"></a>
                <a href="#" class="fi-social-xbox"></a>
                <a href="#" class="fi-social-reddit"></a> -->
                  <a href="https://plus.google.com/u/0/+PeterLawrey" class="fi-social-google-plus"></a>
                  <a href="https://github.com/peter-lawrey" class="fi-social-github"></a>
                  <a href="https://twitter.com/PeterLawrey" class="fi-social-twitter"></a>
            </div>
        </div>
    </div>
</header>

</div>


<div class="small-16 medium-16 large-12 columns main-column left">
    

<main class="content" role="main">

    <article class="post tag-Microservices tag-JDBC tag-Example">


            <h1 class="post-title">A JDBC Gateway Microservice</h1>

            <span class="post-meta label"><time datetime="2016-04-12">12 Apr 2016</time></span>

            <section class="post-content">
                <div class="sect2">
<h3 id="_a_deep_dive_into_a_low_latency_microservice">A deep dive into a low latency microservice</h3>
<div class="paragraph">
<p>We look at a microservice which can run in it&#8217;s own JVM, can perform JDBC updates and queries via a persistent queue for in bound request and a queue for results.</p>
</div>
<div class="paragraph">
<p>In previous posts I looked at the theory behind there low latency micro-services so lets have a look at a micro-service which can do something useful.</p>
</div>
<div class="paragraph">
<p>I would consider this a Gateway Service as it interacts with a system which is outside the microservice model.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_does_this_service_do">What does this service do?</h3>
<div class="paragraph">
<p>The service supports two messages <code>executeQuery</code> and <code>executeUpdate</code>.  These methods mirror the same methods for <code>PreparedStatement</code> except the results are passed as messages</p>
</div>
<div class="listingblock">
<div class="title">Two asynchronous messages in</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface JDBCStatement {
    void executeQuery(String query, Class&lt;? extends Marshallable&gt; resultType, Object... args);

    void executeUpdate(String query, Object... args);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Two asynchronous results, possibly with an Exception thrown</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface JDBCResult {
    void queryResult(Iterator&lt;Marshallable&gt; marshallableList, String query, Object... args);
    void queryThrown(Throwable t, String query, Object... args);

    void updateResult(long count, String update, Object... args);
    void updateThrown(Throwable t, String update, Object... args);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_component_wrapped_as_a_service">Component wrapped as a Service</h3>
<div class="paragraph">
<p>As in previous posts, we create a component which can be executed without a transport.  This can be unit tested stand alone, or with a series of components without the transport complicating testing and debugging.</p>
</div>
<div class="listingblock">
<div class="title">Looking at the executorUpdate method</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class JDBCComponent implements JDBCStatement {
    private final Connection connection;
    private final JDBCResult result;

    public JDBCComponent(ThrowingSupplier&lt;Connection, SQLException&gt; connectionSupplier, JDBCResult result) throws SQLException {
        connection = connectionSupplier.get();
        this.result = result;
    }

    @Override
    public void executeUpdate(String query, Object... args) {
        try (PreparedStatement ps = connection.prepareStatement(query)) {
            for (int i = 0; i &lt; args.length; i++)
                ps.setObject(i + 1, args[i]);
            int count = ps.executeUpdate();
            // record the count.
            result.updateResult(count, query, args);
        } catch (Throwable t) {
            result.updateThrown(t, query, args);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that every input message creates an output message with the results.  This will be useful later for restarting the service from where it got up to and monitoring it&#8217;s progress, as well as obtaining the results.</p>
</div>
<div class="listingblock">
<div class="title">How to wrap this as a service</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class JDBCService implements Closeable {
    private static final Logger LOGGER = LoggerFactory.getLogger(JDBCService.class);
    private final ChronicleQueue in;
    private final ChronicleQueue out;
    private final ExecutorService service;
    private final ThrowingSupplier&lt;Connection, SQLException&gt; connectionSupplier;
    private volatile boolean closed = false;

    public JDBCService(ChronicleQueue in, ChronicleQueue out, ThrowingSupplier&lt;Connection, SQLException&gt; connectionSupplier) throws SQLException {
        this.in = in;
        this.out = out;
        this.connectionSupplier = connectionSupplier;

        service = Executors.newSingleThreadExecutor(
                new NamedThreadFactory(in.file().getName() + "-JDBCService", true)); <i class="conum" data-value="1"></i><b>(1)</b>
        service.execute(this::runLoop); <i class="conum" data-value="2"></i><b>(2)</b>
        service.shutdown(); // stop when the task exits.
    }


    void runLoop() {
        try {
            JDBCResult result = out.createAppender() <i class="conum" data-value="3"></i><b>(3)</b>
                    .methodWriterBuilder(JDBCResult.class)
                    .recordHistory(true)
                    .get();
            JDBCComponent js = new JDBCComponent(connectionSupplier, result);
            MethodReader reader = in.createTailer().afterLastWritten(out).methodReader(js); <i class="conum" data-value="4"></i><b>(4)</b>
            Pauser pauser = new LongPauser(50, 200, 1, 10, TimeUnit.MILLISECONDS);
            while (!closed) {
                if (reader.readOne()) <i class="conum" data-value="5"></i><b>(5)</b>
                    pauser.reset();
                else
                    pauser.pause();
            }
        } catch (Throwable t) {
            LOGGER.error("Run loop exited", t);
        }
    }

    @Override
    public void close() {
        closed = true;
    }

    public JDBCStatement createWriter() {
        return in.createAppender() <i class="conum" data-value="6"></i><b>(6)</b>
                .methodWriterBuilder(JDBCStatement.class)
                .recordHistory(true)
                .get();
    }

    public MethodReader createReader(JDBCResult result) {
        return out.createTailer().methodReader(result);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a thread with a meaningful name. We use an ExecutorService in case we want to do something more complex with it later.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add this task to the pool</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a proxy to write to the output queue</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start reading after the last message to be successfully processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Read one message at a time.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Add a helper method to create a writer to the input of this service</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Add a helper method to read the results of this service.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_it_perform">How does it perform?</h3>
<div class="paragraph">
<p>I tested this writing to HSQLDB which is pretty fast, even writing to a file. Even so, using it as a Service could be useful for very bursty activity as we can handle much higher rates for periods of time.</p>
</div>
<div class="paragraph">
<p>The performance test writes 200K messages as fast as possible and waits for the to all complete.  The first timing is the average latency to write each request, and the second latency is the average time to receive the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Average time to write each update 1.5 us, average time to perform each update 29.7 us</pre>
</div>
</div>
<div class="paragraph">
<p>While HSQLDB was able to sustain over 33 K updates per second, (1 / 29.7 us), the service wrapping could handle bursts of over 660K writes per second. (1 / 1.5 us)  This represents a 20 fold improvement in the burst throughput it can support.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_long_can_a_burst_be">How long can a burst be?</h3>
<div class="paragraph">
<p>Both Linux and Windows tend to perform well up to 10% of main memory being "dirty" or not written to disk. For example, if you have 256 GB, you can have 25 GB of "dirty" data.  Even so, if the burst rate is faster than the consuming service, but slow enough that the disk subsystem can keep up, your bursts can exceed main memory size.  To put that in context, if your messages are 256 bytes long, the service could be behind by more than one billion messages, and it will not run out of memory, or fail.  The main limitation in this case, is the amount of free disk space you have.  At the time of posting you can buy 1 TB of Enterprise SSD for less than $600, and Samsung is selling 16 TB SSD drives. I expect  storage costs will continue to fall.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>Building a microservice by wrapping a component with an asynchronous API with a transport for messaging in and out has worked without too much complexity.</p>
</div>
<div class="paragraph">
<p>The best way to go fast is to do less work.</p>
</div>
</div>
                        <aside class="tags fi-pricetag-multiple">Posted on <a href="https://vanilla-java.github.io/tag/Microservices/">Microservices</a>, <a href="https://vanilla-java.github.io/tag/JDBC/">JDBC</a>, <a href="https://vanilla-java.github.io/tag/Example/">Example</a></aside>
            </section>
            <hr>
            <footer class="post-footer">

                <section class="share">
                    <h4>Liked this post ? Share it.</h4>
                    <a class="fi-social-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    </a>
                    <a class="fi-social-twitter" href="https://twitter.com/share?text=A%20JDBC%20Gateway%20Microservice&amp;url=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    </a>
                    <a class="fi-social-google-plus" href="https://plus.google.com/share?url=https://vanilla-java.github.io/"
                       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    </a>
                </section>

                <section class="author">
                    <header>
                        <span>About the author</span>
                    </header>
                    <section>
                        <h4>Peter Lawrey</h4>
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4">
                        <span>London</span>
                        <a href="http://vanillajava.blogspot.com/">http://vanillajava.blogspot.com/</a>
                    </section>
                    <footer>
                         <p>Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion</p>
                    </footer>
                </section>

        <div class="clearfix"></div>
                    <hr>

            </footer>

        <h3 class="title-disqus"><span class="fi-comments"></span>Discussions</h3>




        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

</div>

</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

    <!--[if lte IE 8]>
        <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/outdatedBrowser.min.js?v=1536077025213"></script>
    <![endif]-->
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/min/built.js?v=1536077025213"></script>

    <script>
      $(document).foundation();
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
