<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Microservices in the Chronicle world - Part 4</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/fastclick.js?v=1536077025277"></script>
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/modernizr.js?v=1536077025277"></script>


    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/normalize.css?v=1536077025277" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/foundation.min.css?v=1536077025277" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/outdatedBrowser.min.css?v=1536077025277">
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/fonts/foundation-icons/foundation-icons.css?v=1536077025277" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/styles.css?v=1536077025277" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300,700,400|Source+Sans+Pro:300,400,600,700,900,300italic,400italic,600italic,700italic,900italic" />

    <link rel="canonical" href="https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Microservices in the Chronicle world - Part 4" />
    <meta property="og:description" content="A common issue we cover in our workshops is, how to restart a queue reader after a failure. The answer is not a simple as you might think. We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has" />
    <meta property="og:url" content="https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html" />
    <meta property="article:published_time" content="2016-03-29T00:00:00.000Z" />
    <meta property="article:tag" content="Microservices" />
    <meta property="article:tag" content="Restarting" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Microservices in the Chronicle world - Part 4" />
    <meta name="twitter:description" content="A common issue we cover in our workshops is, how to restart a queue reader after a failure. The answer is not a simple as you might think. We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Microservices in the Chronicle world - Part 4",
    "url": "https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html",
    "datePublished": "2016-03-29T00:00:00.000Z",
    "keywords": "Microservices, Restarting",
    "description": "A common issue we cover in our workshops is, how to restart a queue reader after a failure. The answer is not a simple as you might think. We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Microservices tag-Restarting">

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdate" href="http://outdatedbrowser.com/">Update my browser now</a></p>
</div>

<nav class="top-bar hide-for-large-up" data-topbar style="background: none">
  <ul class="title-area">
    <li class="name">

    </li>
    <li class="home"><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
    <li class="toggle-topbar"><a href="#" id="trigger-overlay" class="fi-list"></a></li>
  </ul>

<div class="overlay overlay-scale">
    <button type="button" class="overlay-close">Close</button>
    <nav>
        <ul>
            <li><a href="https://vanilla-java.github.io">Home</a></li>
        </ul>
    </nav>
</div>

</nav>

<div class="row">

<div class="small-16 medium-16 large-4 columns right head-area bgimage" style="background-image: url(https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg)">

<header class="site-head">
    <div class="vertical">
        <div class="site-head-content inner">
            <ul class="side-nav blog-menu show-for-large-up">
                <li><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
                <li><a class="fi-torso" href="https://vanilla-java.github.io/about"></a></li>
                <li><a class="fi-mail" href="https://vanilla-java.github.io/contact"></a></li>
            </ul>
            <a class="blog-logo" href="https://vanilla-java.github.io"><img alt="Vanilla Java" src="https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg" alt="Blog Logo" /></a>
            <h1 class="blog-title">Vanilla Java</h1>
            <hr>
            <p class="blog-description"></p>
            <div class="blog-network">
<!--                 <a href="#" class="fi-social-pinterest"></a>
                <a href="#" class="fi-social-linkedin"></a>
                <a href="#" class="fi-social-behance"></a>
                <a href="#" class="fi-social-deviant-art"></a>
                <a href="#" class="fi-social-dribbble"></a>
                <a href="#" class="fi-social-flickr"></a>
                <a href="#" class="fi-social-github"></a>
                <a href="#" class="fi-social-skype"></a>
                <a href="#" class="fi-social-snapchat"></a>
                <a href="#" class="fi-social-steam"></a>
                <a href="#" class="fi-social-xbox"></a>
                <a href="#" class="fi-social-reddit"></a> -->
                  <a href="https://plus.google.com/u/0/+PeterLawrey" class="fi-social-google-plus"></a>
                  <a href="https://github.com/peter-lawrey" class="fi-social-github"></a>
                  <a href="https://twitter.com/PeterLawrey" class="fi-social-twitter"></a>
            </div>
        </div>
    </div>
</header>

</div>


<div class="small-16 medium-16 large-12 columns main-column left">
    

<main class="content" role="main">

    <article class="post tag-Microservices tag-Restarting">


            <h1 class="post-title">Microservices in the Chronicle world - Part 4</h1>

            <span class="post-meta label"><time datetime="2016-03-29">29 Mar 2016</time></span>

            <section class="post-content">
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A common issue we cover in our workshops is, <em>how to restart a queue reader after a failure.</em></p>
</div>
<div class="paragraph">
<p>The answer is not a simple as you might think.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has a good balance of speed and simplicity.  Often, simplicity is the most important and it will also be fast enough. You can contact <a href="mailto:sales@chronicle.software">Chronicle Software Sales</a> for more details.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_knowing_when_a_message_should_be_replayed_on_startup">Knowing when a message should be replayed on startup.</h3>
<div class="paragraph">
<p>It&#8217;s not enough to know which messages have been played.  You need to know which messages were completed successfully in a transaction. This assumes you must have each message processed exactly once. Simpler alternatives are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Play every message again and ignore duplicates.</p>
</li>
<li>
<p>Play every message from the end (or the last <em>N</em> minutes) and assume anything older than that has expired.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When updating a database, one way to achieve this is to update the index read in a row in the database, this way either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The transaction succeeds and the message doesn&#8217;t need to be played again.</p>
</li>
<li>
<p>The transaction fails and the message does need to be played again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The important detail is that there is no situation where it is unclear whether the input message should be replayed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_restarting_a_reader_when_writing_to_a_queue_as_output">Restarting a reader when writing to a queue as output.</h3>
<div class="paragraph">
<p>In general, we suggest you write your results to an output queue.  An output queue can be a replacement for logging and a means of monitoring, but can also record where each event came from.
In particular, and output queue can help:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replay messages in the same order, which were sourced from multiple input queue.</p>
</li>
<li>
<p>Ensure that after an upgrade of your software, you honour the decisions you made earlier. i.e. new software replaying the input message might make different decisions. By reading from the output, you ensure that after an upgrade you know what state you should be in.</p>
</li>
<li>
<p>Restart an input queue from the last message successfully outputed for an input from that queue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example, it reads just one unprocessed message.</p>
</div>
<div class="listingblock">
<div class="title">Read one message which hasn&#8217;t been processed.</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try (SingleChronicleQueue in = SingleChronicleQueueBuilder.binary(queuePath)
        .sourceId(1) <i class="conum" data-value="1"></i><b>(1)</b>
        .build();
     SingleChronicleQueue out = SingleChronicleQueueBuilder.binary(queuePath2)
             .rollCycle(RollCycles.TEST_DAILY)
             .build()) {

    MarketDataListener mdListener = out.createAppender()
            .methodWriterBuilder(MarketDataListener.class)
            .recordHistory(true) <i class="conum" data-value="2"></i><b>(2)</b>
            .get();
    SidedMarketDataCombiner combiner = new SidedMarketDataCombiner(mdListener);
    MethodReader reader = in.createTailer()
            .afterLastWritten(out) <i class="conum" data-value="3"></i><b>(3)</b>
            .methodReader(combiner);
    assertTrue(reader.readOne());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Give the queue a unique id for tracing purposes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Write a history for timings and sources for each message processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Read the output queue to see what the last message processed was.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It would be really inefficient to do all this every time. The only line which is required for each message is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">reader.readOne();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>While there is a number of ways you could implement restart, if you need it, it is useful to have built-in support for one of the most common ways to do this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_in_the_next_part">In the next part.</h3>
<div class="paragraph">
<p><a href="https://vanilla-java.github.io/2016/04/02/Microservices-in-the-Chronicle-World-Part-5.html">How does this perform end to end with multiple asynchronous services are how can we measure there?</a></p>
</div>
</div>
                        <aside class="tags fi-pricetag-multiple">Posted on <a href="https://vanilla-java.github.io/tag/Microservices/">Microservices</a>, <a href="https://vanilla-java.github.io/tag/Restarting/">Restarting</a></aside>
            </section>
            <hr>
            <footer class="post-footer">

                <section class="share">
                    <h4>Liked this post ? Share it.</h4>
                    <a class="fi-social-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    </a>
                    <a class="fi-social-twitter" href="https://twitter.com/share?text=Microservices%20in%20the%20Chronicle%20world%20-%20Part%204&amp;url=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    </a>
                    <a class="fi-social-google-plus" href="https://plus.google.com/share?url=https://vanilla-java.github.io/"
                       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    </a>
                </section>

                <section class="author">
                    <header>
                        <span>About the author</span>
                    </header>
                    <section>
                        <h4>Peter Lawrey</h4>
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4">
                        <span>London</span>
                        <a href="http://vanillajava.blogspot.com/">http://vanillajava.blogspot.com/</a>
                    </section>
                    <footer>
                         <p>Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion</p>
                    </footer>
                </section>

        <div class="clearfix"></div>
                    <hr>

            </footer>

        <h3 class="title-disqus"><span class="fi-comments"></span>Discussions</h3>




        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

</div>

</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

    <!--[if lte IE 8]>
        <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/outdatedBrowser.min.js?v=1536077025277"></script>
    <![endif]-->
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/min/built.js?v=1536077025277"></script>

    <script>
      $(document).foundation();
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
