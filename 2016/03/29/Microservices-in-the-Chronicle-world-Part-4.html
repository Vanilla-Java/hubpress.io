<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Microservices in the Chronicle world - Part 4</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Open+Sans:400italic,700italic,700,400">
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/roon/assets/css/screen.css?v=1536077092929" />

    <link rel="canonical" href="https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Microservices in the Chronicle world - Part 4" />
    <meta property="og:description" content="A common issue we cover in our workshops is, how to restart a queue reader after a failure. The answer is not a simple as you might think. We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has" />
    <meta property="og:url" content="https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html" />
    <meta property="article:published_time" content="2016-03-29T00:00:00.000Z" />
    <meta property="article:tag" content="Microservices" />
    <meta property="article:tag" content="Restarting" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Microservices in the Chronicle world - Part 4" />
    <meta name="twitter:description" content="A common issue we cover in our workshops is, how to restart a queue reader after a failure. The answer is not a simple as you might think. We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Microservices in the Chronicle world - Part 4",
    "url": "https://vanilla-java.github.io/2016/03/29/Microservices-in-the-Chronicle-world-Part-4.html",
    "datePublished": "2016-03-29T00:00:00.000Z",
    "keywords": "Microservices, Restarting",
    "description": "A common issue we cover in our workshops is, how to restart a queue reader after a failure. The answer is not a simple as you might think. We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Microservices tag-Restarting  noimage">

    


    <article role="main" class="">
        <header>
            <a href="https://vanilla-java.github.io" id="home_link">Â«</a>
            <div class="meta"><time datetime="2016-03-29"><a href="/">March 29, 2016</a></time> <span class="count" id="js-reading-time"></span></div>
            <h1>Microservices in the Chronicle world - Part 4</h1>
        </header>

        <div class="text" id="js-post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A common issue we cover in our workshops is, <em>how to restart a queue reader after a failure.</em></p>
</div>
<div class="paragraph">
<p>The answer is not a simple as you might think.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do an on-site one week workshop to help kick start a new project, with a look at ensuring the infrastructure has a good balance of speed and simplicity.  Often, simplicity is the most important and it will also be fast enough. You can contact <a href="mailto:sales@chronicle.software">Chronicle Software Sales</a> for more details.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_knowing_when_a_message_should_be_replayed_on_startup">Knowing when a message should be replayed on startup.</h3>
<div class="paragraph">
<p>It&#8217;s not enough to know which messages have been played.  You need to know which messages were completed successfully in a transaction. This assumes you must have each message processed exactly once. Simpler alternatives are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Play every message again and ignore duplicates.</p>
</li>
<li>
<p>Play every message from the end (or the last <em>N</em> minutes) and assume anything older than that has expired.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When updating a database, one way to achieve this is to update the index read in a row in the database, this way either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The transaction succeeds and the message doesn&#8217;t need to be played again.</p>
</li>
<li>
<p>The transaction fails and the message does need to be played again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The important detail is that there is no situation where it is unclear whether the input message should be replayed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_restarting_a_reader_when_writing_to_a_queue_as_output">Restarting a reader when writing to a queue as output.</h3>
<div class="paragraph">
<p>In general, we suggest you write your results to an output queue.  An output queue can be a replacement for logging and a means of monitoring, but can also record where each event came from.
In particular, and output queue can help:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replay messages in the same order, which were sourced from multiple input queue.</p>
</li>
<li>
<p>Ensure that after an upgrade of your software, you honour the decisions you made earlier. i.e. new software replaying the input message might make different decisions. By reading from the output, you ensure that after an upgrade you know what state you should be in.</p>
</li>
<li>
<p>Restart an input queue from the last message successfully outputed for an input from that queue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example, it reads just one unprocessed message.</p>
</div>
<div class="listingblock">
<div class="title">Read one message which hasn&#8217;t been processed.</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">try (SingleChronicleQueue in = SingleChronicleQueueBuilder.binary(queuePath)
        .sourceId(1) <i class="conum" data-value="1"></i><b>(1)</b>
        .build();
     SingleChronicleQueue out = SingleChronicleQueueBuilder.binary(queuePath2)
             .rollCycle(RollCycles.TEST_DAILY)
             .build()) {

    MarketDataListener mdListener = out.createAppender()
            .methodWriterBuilder(MarketDataListener.class)
            .recordHistory(true) <i class="conum" data-value="2"></i><b>(2)</b>
            .get();
    SidedMarketDataCombiner combiner = new SidedMarketDataCombiner(mdListener);
    MethodReader reader = in.createTailer()
            .afterLastWritten(out) <i class="conum" data-value="3"></i><b>(3)</b>
            .methodReader(combiner);
    assertTrue(reader.readOne());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Give the queue a unique id for tracing purposes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Write a history for timings and sources for each message processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Read the output queue to see what the last message processed was.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It would be really inefficient to do all this every time. The only line which is required for each message is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">reader.readOne();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>While there is a number of ways you could implement restart, if you need it, it is useful to have built-in support for one of the most common ways to do this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_in_the_next_part">In the next part.</h3>
<div class="paragraph">
<p><a href="https://vanilla-java.github.io/2016/04/02/Microservices-in-the-Chronicle-World-Part-5.html">How does this perform end to end with multiple asynchronous services are how can we measure there?</a></p>
</div>
</div>
        </div>

        <menu>
            <a href="" id="btn_share" class="btn" title="Share">
                <span aria-hidden="true" data-icon="S"></span>
                <strong>Share</strong>
            </a>
            <a href="http://twitter.com/share?text=Microservices%20in%20the%20Chronicle%20world%20-%20Part%204&url=https://vanilla-java.github.io/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" id="btn_comment" class="btn" target="_blank">
                <span aria-hidden="true" data-icon="C"></span> Comment on Twitter
            </a>
        </menu>


        <footer class="post-footer" role="contentinfo">

            <div class="vcard">
                <a href="https://vanilla-java.github.io/rss" id="btn_feed" class="btn" title="Feed" target="_blank">
                    <span aria-hidden="true" data-icon=")"></span>
                    <strong>Feed</strong>
                </a>

                <a href="https://vanilla-java.github.io/author/peter-lawrey/" class="photo">
                    <span style="background-image: url('https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4');">
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4" alt="Peter Lawrey">
                    </span>
                </a>

                <div class="details">
                    <h4><a href="https://vanilla-java.github.io/author/peter-lawrey/" class="url n">Peter Lawrey</a></h4>
                    London<br>
                    <a href="http://vanillajava.blogspot.com/" class="js-remove-domain-schema">http://vanillajava.blogspot.com/</a>
                </div>
            </div>

            <div id="user_bio">
                <div class="inner">
                    Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion
                </div>
            </div>

        </footer>




    <section class="post-comments">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
      var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>


    </article>

    <div id="share_modal">
        <div class="wrap">
            <div class="inner">
                <header>
                    Share
                    <a href="" class="close" title="Close">&times;</a>
                </header>

                <div class="roon-share-links">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    <div id="fb-elems">
                        <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) return;
                        js = d.createElement(s); js.id = id;
                        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=463438580397968";
                        fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));</script>
                        <div class="fb-like" data-send="false" data-layout="button_count" data-width="110" data-show-faces="false" data-font="arial"></div>
                    </div>

                    <div id="pinit-btn">
                        <a href="//pinterest.com/pin/create/button/?url=https://vanilla-java.github.io/&amp;description=Microservices%20in%20the%20Chronicle%20world%20-%20Part%204-Vanilla%20Java " data-pin-do="buttonPin" data-pin-config="beside"><img src="//assets.pinterest.com/images/pidgets/pin_it_button.png"></a>
                        <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>




        <a href="https://vanilla-java.github.io" id="blog_badge">
            <span style="background-image: url('https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg');">Vanilla Java</span>
        </a>


    <script>

            function get_text(el) {
                ret = "";
                var length = el.childNodes.length;
                for(var i = 0; i < length; i++) {
                    var node = el.childNodes[i];
                    if(node.nodeType != 8) {
                        ret += node.nodeType != 1 ? node.nodeValue : get_text(node);
                    }
                }
                return ret;
            }
            function reading_time () {
                var post_content = document.getElementById('js-post-content');
                if (post_content) {
                    var words = get_text(post_content),
                        count = words.split(/\s+/).length,
                        read_time = Math.ceil((count / 150)),
                        read_time_node = document.createTextNode(read_time + ' min read');
                    document.getElementById('js-reading-time').appendChild(read_time_node);
                }
            }

        function no_schema_links () {
            var links = document.querySelectorAll('.js-remove-domain-schema');
            if (links) {
                for (i = 0; i < links.length; ++i) {
                    var link = links[i],
                        text = link.innerHTML,
                        no_schema = text.replace(/.*?:\/\//g, "");
                    link.innerHTML = no_schema;
                }
            }
        }

        window.onload = function () {
            no_schema_links();

            reading_time();
        }
    </script>


    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

        <script>
            $(function(){
                var share_modal = $("#share_modal"),
                    update_social_links = true;

                $("#btn_share").click(function(){
                    var that = $(this);
                    share_modal.fadeIn(200);
                    return false;
                });

                share_modal.click(function(e){
                    if (e.target.className == "wrap" || e.target.id == "share_modal") {
                        share_modal.fadeOut(200);
                    }
                    return false;
                });

                share_modal.find("div.inner > header > a.close").click(function(){
                    share_modal.fadeOut(200);
                    return false;
                });
            });
        </script>


    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>

</body>
</html>
