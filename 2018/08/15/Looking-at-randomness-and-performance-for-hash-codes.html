<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Looking at randomness and performance for hash codes</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Open+Sans:400italic,700italic,700,400">
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/roon/assets/css/screen.css?v=1536077091714" />

    <link rel="canonical" href="https://vanilla-java.github.io/2018/08/15/Looking-at-randomness-and-performance-for-hash-codes.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Looking at randomness and performance for hash codes" />
    <meta property="og:description" content="In these articles, String.hashCode() is not even a little unique and Why do I this String.hashCode() is poor, I looked at how String.hashCode() might have been made better with little change at the time it was last updated (in Java 1.2). However, given the current solution" />
    <meta property="og:url" content="https://vanilla-java.github.io/2018/08/15/Looking-at-randomness-and-performance-for-hash-codes.html" />
    <meta property="article:published_time" content="2018-08-15T00:00:00.000Z" />
    <meta property="article:tag" content="String" />
    <meta property="article:tag" content="hashCode" />
    <meta property="article:tag" content="performance" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Looking at randomness and performance for hash codes" />
    <meta name="twitter:description" content="In these articles, String.hashCode() is not even a little unique and Why do I this String.hashCode() is poor, I looked at how String.hashCode() might have been made better with little change at the time it was last updated (in Java 1.2). However, given the current solution" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2018/08/15/Looking-at-randomness-and-performance-for-hash-codes.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Looking at randomness and performance for hash codes",
    "url": "https://vanilla-java.github.io/2018/08/15/Looking-at-randomness-and-performance-for-hash-codes.html",
    "datePublished": "2018-08-15T00:00:00.000Z",
    "keywords": "String, hashCode, performance",
    "description": "In these articles, String.hashCode() is not even a little unique and Why do I this String.hashCode() is poor, I looked at how String.hashCode() might have been made better with little change at the time it was last updated (in Java 1.2). However, given the current solution"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-String tag-hash-Code tag-performance  noimage">

    


    <article role="main" class="">
        <header>
            <a href="https://vanilla-java.github.io" id="home_link">Â«</a>
            <div class="meta"><time datetime="2018-08-15"><a href="/">August 15, 2018</a></time> <span class="count" id="js-reading-time"></span></div>
            <h1>Looking at randomness and performance for hash codes</h1>
        </header>

        <div class="text" id="js-post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In these articles, <a href="https://vanilla-java.github.io/2018/07/26/Stringhash-Code-is-not-even-a-little-unique.html">String.hashCode() is not even a little unique</a> and <a href="https://vanilla-java.github.io/2018/08/12/Why-do-I-think-Stringhash-Code-is-poor.html">Why do I this String.hashCode() is poor</a>, I looked at how String.hashCode() might have been made better with little change at the time it was last updated (in Java 1.2). However, given the current solution has been in place for 20 years, the default behaviour is unlikely to change. Additionally, if we were to consider different a different algorithm I would prefer something much faster and more random than just changing the prime factor from 31 to 109.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_can_we_evaluate_randomness">How can we evaluate randomness?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One way of looking at randomness is to change the input by one bit and see how many bits change in the resulting hash. The input is first populated with random data and the resulting hashes are compared for a large sample. In this case, I took one million samples and plotted it against what you get for a <code>Random.nextInt()</code> call.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ideal hash changes half of the bits on average, more than half bits changed is also a bias.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/randomness-64-bytes.png" alt="randomness 64 bytes">
</div>
<div class="title">Figure 1. The randomness of the hash code for different strategies for longer inputs compared with Random all have decent outcomes</div>
</div>
<div class="listingblock">
<div class="title">Harness to estimate the randomness distribution of a hashing strategy.</div>
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">static double[] randomnessDistribution(ToIntFunction&lt;byte[]&gt; hashCode, int length) {
    double[] dist = new double[33];
    Random random = new Random(length);
    byte[] bytes = new byte[length];
    int tests = 0;
    for (int t = 0; t &lt; 1000000; t += length) {
        for (int i = 0; i &lt; length; i++)
            bytes[i] = (byte) (' ' + random.nextInt(96)); <i class="conum" data-value="1"></i><b>(1)</b>
        int base = hashCode.applyAsInt(bytes);

        for (int i = 0; i &lt; length; i++) {
            for (int j = 0; j &lt; 8; j++) {
                bytes[i] ^= 1 &lt;&lt; j;
                int val = hashCode.applyAsInt(bytes);
                int score2 = Integer.bitCount(base ^ val);
                dist[score2]++;
                tests++;
                bytes[i] ^= 1 &lt;&lt; j;
            }
        }
    }
    for (int i = 0; i &lt; dist.length; i++)
        dist[i] = Math.round(1000.0 * dist[i] / tests) / 10.0;
    return dist;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I assume the input is largely ASCII or positive bytes. This doesn&#8217;t change the results greatly.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Print the distribution of different strategies for charting.</div>
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">for(double[] dist: new double[][] {
        randomnessDistribution(HashCodeBenchmarkMain::hashCode31, length),
        randomnessDistribution(Arrays::hashCode, length),
        randomnessDistribution(HashCodeBenchmarkMain::hashCode109, length),
        randomnessDistribution(HashCodeBenchmarkMain::nativeHashCode, length),
        randomnessDistribution(value -&gt; ThreadLocalRandom.current().nextInt(), length)}) {
    System.out.println(Arrays.toString(dist).replaceAll("(\\[|\\])", ""));
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Modified form of the String.hashCode() using 109 as a prime.</div>
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">static int hashCode109(byte[] value) {
    if (value.length == 0) return 0;
    int h = value[0]; <i class="conum" data-value="1"></i><b>(1)</b>
    for (int i = 1; i &lt; value.length; i++) {
        h = h * 109 + value[i];
    }
    h *= 109; <i class="conum" data-value="2"></i><b>(2)</b>
    return h;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>On the first iteration don&#8217;t need to multiply the previous value.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Afterwards, multiply by the factor to improve the outcomes for short inputs.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The differences between hashing strategies are more obvious for shorter inputs.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/randomness-20-bytes.png" alt="randomness 20 bytes">
</div>
<div class="title">Figure 2. Most strategies tested do well for 20-byte inputs</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/randomness-8-bytes.png" alt="randomness 8 bytes">
</div>
<div class="title">Figure 3. For 8-byte inputs, some strategies are not ideal</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/randomness-4-bytes.png" alt="randomness 4 bytes">
</div>
<div class="title">Figure 4. For 4 byte inputs, String.hashCode() and Arrays.hashCode() are poor</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/randomness-2-bytes.png" alt="randomness 2 bytes">
</div>
<div class="title">Figure 5. For 2 byte inputs, String.hashCode() and Arrays.hashCode() are not great</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/randomness-1-byte.png" alt="randomness 1 byte">
</div>
<div class="title">Figure 6. For 1 byte inputs, String.hashCode() and Arrays.hashCode() might be fine as the number of possible keys is small.</div>
</div>
<div class="sect2">
<h3 id="_what_is_this_native_hashcode">What is this "native" hashCode?</h3>
<div class="paragraph">
<p>A technique we use to speed up the processing of bytes is to attempt to process groups of them at once i.e. 4 bytes or 8 bytes at a time. This can speed up processing by 2-4x. We also see a benefit in using a larger prime as we pass through fewer iterations.</p>
</div>
<div class="listingblock">
<div class="title">Hashing strategy which takes 4 bytes aa time</div>
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">private static final int M2 = 0x7A646E4D;

// read 4 bytes at a time from a byte[] assuming Java 9+ Compact Strings
private static int getIntFromArray(byte[] value, int i) {
    return UnsafeMemory.INSTANCE.UNSAFE.getInt(value, BYTE_ARRAY_OFFSET + i); <i class="conum" data-value="0"></i><b>(0)</b>
}

public static int nativeHashCode(byte[] value) {
    long h = getIntFromArray(value, 0);
    for (int i = 4; i &lt; value.length; i += 4)
        h = h * M2 + getIntFromArray(value, i); <i class="conum" data-value="1"></i><b>(1)</b>
    h *= M2;
    return (int) h ^ (int) (h &gt;&gt;&gt; 25);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>assess assumes all byte[] have zero byte padding at the end and aligned to a multiple of 4 bytes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>in each iteration multiply by a large constant</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>agitate the results using some of the high bits</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_how_can_we_measure_how_they_perform">How can we measure how they perform?</h3>
<div class="paragraph">
<p>Using JMH, we can benchmark how long each operation takes on average.  To have reasonable coverage, the benchmark tried a number of sizes so this is the average for those sizes.</p>
</div>
<div class="listingblock">
<div class="title">Benchmark comparing the throughput of using String.hashCode with 31 or 109 and the native hashing strategy.</div>
<div class="content">
<pre>Benchmark                                      Mode  Cnt   Score   Error   Units
HashCodeBenchmarkMain.String_hashCode         thrpt   25  15.586 Â± 0.433  ops/us
HashCodeBenchmarkMain.String_hashCode109      thrpt   25  13.480 Â± 0.147  ops/us
HashCodeBenchmarkMain.String_hashCode31       thrpt   25  16.173 Â± 0.205  ops/us
HashCodeBenchmarkMain.String_native_hashCode  thrpt   25  55.547 Â± 2.051  ops/us</pre>
</div>
</div>
<div class="paragraph">
<p>The native implementation is around 3-4 times as it processes up to 4 bytes at a time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_code">The code</h3>
<div class="paragraph">
<p>A maven module of code exploring how String is hashed is <a href="https://github.com/peter-lawrey/Java-Lost/tree/master/java-string-hashcode">HERE</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>I believe it is possible to produce a hashing strategy which is both much faster and has a better hash distribution than the 20-year-old solution.  Changing the JVM is impractical however having a pluggable hashing strategy for XxxxHashMap might ensure backward compatibility while providing an option for a faster solution.</p>
</div>
</div>
</div>
</div>
        </div>

        <menu>
            <a href="" id="btn_share" class="btn" title="Share">
                <span aria-hidden="true" data-icon="S"></span>
                <strong>Share</strong>
            </a>
            <a href="http://twitter.com/share?text=Looking%20at%20randomness%20and%20performance%20for%20hash%20codes&url=https://vanilla-java.github.io/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" id="btn_comment" class="btn" target="_blank">
                <span aria-hidden="true" data-icon="C"></span> Comment on Twitter
            </a>
        </menu>


        <footer class="post-footer" role="contentinfo">

            <div class="vcard">
                <a href="https://vanilla-java.github.io/rss" id="btn_feed" class="btn" title="Feed" target="_blank">
                    <span aria-hidden="true" data-icon=")"></span>
                    <strong>Feed</strong>
                </a>

                <a href="https://vanilla-java.github.io/author/peter-lawrey/" class="photo">
                    <span style="background-image: url('https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4');">
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4" alt="Peter Lawrey">
                    </span>
                </a>

                <div class="details">
                    <h4><a href="https://vanilla-java.github.io/author/peter-lawrey/" class="url n">Peter Lawrey</a></h4>
                    London<br>
                    <a href="http://vanillajava.blogspot.com/" class="js-remove-domain-schema">http://vanillajava.blogspot.com/</a>
                </div>
            </div>

            <div id="user_bio">
                <div class="inner">
                    Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion
                </div>
            </div>

        </footer>




    <section class="post-comments">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
      var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>


    </article>

    <div id="share_modal">
        <div class="wrap">
            <div class="inner">
                <header>
                    Share
                    <a href="" class="close" title="Close">&times;</a>
                </header>

                <div class="roon-share-links">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    <div id="fb-elems">
                        <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) return;
                        js = d.createElement(s); js.id = id;
                        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=463438580397968";
                        fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));</script>
                        <div class="fb-like" data-send="false" data-layout="button_count" data-width="110" data-show-faces="false" data-font="arial"></div>
                    </div>

                    <div id="pinit-btn">
                        <a href="//pinterest.com/pin/create/button/?url=https://vanilla-java.github.io/&amp;description=Looking%20at%20randomness%20and%20performance%20for%20hash%20codes-Vanilla%20Java " data-pin-do="buttonPin" data-pin-config="beside"><img src="//assets.pinterest.com/images/pidgets/pin_it_button.png"></a>
                        <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>




        <a href="https://vanilla-java.github.io" id="blog_badge">
            <span style="background-image: url('https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg');">Vanilla Java</span>
        </a>


    <script>

            function get_text(el) {
                ret = "";
                var length = el.childNodes.length;
                for(var i = 0; i < length; i++) {
                    var node = el.childNodes[i];
                    if(node.nodeType != 8) {
                        ret += node.nodeType != 1 ? node.nodeValue : get_text(node);
                    }
                }
                return ret;
            }
            function reading_time () {
                var post_content = document.getElementById('js-post-content');
                if (post_content) {
                    var words = get_text(post_content),
                        count = words.split(/\s+/).length,
                        read_time = Math.ceil((count / 150)),
                        read_time_node = document.createTextNode(read_time + ' min read');
                    document.getElementById('js-reading-time').appendChild(read_time_node);
                }
            }

        function no_schema_links () {
            var links = document.querySelectorAll('.js-remove-domain-schema');
            if (links) {
                for (i = 0; i < links.length; ++i) {
                    var link = links[i],
                        text = link.innerHTML,
                        no_schema = text.replace(/.*?:\/\//g, "");
                    link.innerHTML = no_schema;
                }
            }
        }

        window.onload = function () {
            no_schema_links();

            reading_time();
        }
    </script>


    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

        <script>
            $(function(){
                var share_modal = $("#share_modal"),
                    update_social_links = true;

                $("#btn_share").click(function(){
                    var that = $(this);
                    share_modal.fadeIn(200);
                    return false;
                });

                share_modal.click(function(e){
                    if (e.target.className == "wrap" || e.target.id == "share_modal") {
                        share_modal.fadeOut(200);
                    }
                    return false;
                });

                share_modal.find("div.inner > header > a.close").click(function(){
                    share_modal.fadeOut(200);
                    return false;
                });
            });
        </script>


    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>

</body>
</html>
