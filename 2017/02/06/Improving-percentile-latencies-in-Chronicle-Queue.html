<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Improving percentile latencies in Chronicle Queue</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/fastclick.js?v=1536077024637"></script>
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/modernizr.js?v=1536077024637"></script>


    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/normalize.css?v=1536077024637" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/foundation.min.css?v=1536077024637" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/outdatedBrowser.min.css?v=1536077024637">
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/fonts/foundation-icons/foundation-icons.css?v=1536077024637" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/styles.css?v=1536077024637" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300,700,400|Source+Sans+Pro:300,400,600,700,900,300italic,400italic,600italic,700italic,900italic" />

    <link rel="canonical" href="https://vanilla-java.github.io/2017/02/06/Improving-percentile-latencies-in-Chronicle-Queue.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Improving percentile latencies in Chronicle Queue" />
    <meta property="og:description" content="Compared to a year ago, we have significantly improved the throughput at which we can achieve the 99%ile (worst one in 100). What tools and tricks did we use to achieve that? What are we testing? Chronicle Queue appends messages to a file while another thread or process can" />
    <meta property="og:url" content="https://vanilla-java.github.io/2017/02/06/Improving-percentile-latencies-in-Chronicle-Queue.html" />
    <meta property="article:published_time" content="2017-02-06T00:00:00.000Z" />
    <meta property="article:tag" content="Chronicle Queue" />
    <meta property="article:tag" content="Low Latency" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Improving percentile latencies in Chronicle Queue" />
    <meta name="twitter:description" content="Compared to a year ago, we have significantly improved the throughput at which we can achieve the 99%ile (worst one in 100). What tools and tricks did we use to achieve that? What are we testing? Chronicle Queue appends messages to a file while another thread or process can" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2017/02/06/Improving-percentile-latencies-in-Chronicle-Queue.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Improving percentile latencies in Chronicle Queue",
    "url": "https://vanilla-java.github.io/2017/02/06/Improving-percentile-latencies-in-Chronicle-Queue.html",
    "datePublished": "2017-02-06T00:00:00.000Z",
    "keywords": "Chronicle Queue, Low Latency",
    "description": "Compared to a year ago, we have significantly improved the throughput at which we can achieve the 99%ile (worst one in 100). What tools and tricks did we use to achieve that? What are we testing? Chronicle Queue appends messages to a file while another thread or process can"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Chronicle-Queue tag-Low-Latency">

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdate" href="http://outdatedbrowser.com/">Update my browser now</a></p>
</div>

<nav class="top-bar hide-for-large-up" data-topbar style="background: none">
  <ul class="title-area">
    <li class="name">

    </li>
    <li class="home"><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
    <li class="toggle-topbar"><a href="#" id="trigger-overlay" class="fi-list"></a></li>
  </ul>

<div class="overlay overlay-scale">
    <button type="button" class="overlay-close">Close</button>
    <nav>
        <ul>
            <li><a href="https://vanilla-java.github.io">Home</a></li>
        </ul>
    </nav>
</div>

</nav>

<div class="row">

<div class="small-16 medium-16 large-4 columns right head-area bgimage" style="background-image: url(https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg)">

<header class="site-head">
    <div class="vertical">
        <div class="site-head-content inner">
            <ul class="side-nav blog-menu show-for-large-up">
                <li><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
                <li><a class="fi-torso" href="https://vanilla-java.github.io/about"></a></li>
                <li><a class="fi-mail" href="https://vanilla-java.github.io/contact"></a></li>
            </ul>
            <a class="blog-logo" href="https://vanilla-java.github.io"><img alt="Vanilla Java" src="https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg" alt="Blog Logo" /></a>
            <h1 class="blog-title">Vanilla Java</h1>
            <hr>
            <p class="blog-description"></p>
            <div class="blog-network">
<!--                 <a href="#" class="fi-social-pinterest"></a>
                <a href="#" class="fi-social-linkedin"></a>
                <a href="#" class="fi-social-behance"></a>
                <a href="#" class="fi-social-deviant-art"></a>
                <a href="#" class="fi-social-dribbble"></a>
                <a href="#" class="fi-social-flickr"></a>
                <a href="#" class="fi-social-github"></a>
                <a href="#" class="fi-social-skype"></a>
                <a href="#" class="fi-social-snapchat"></a>
                <a href="#" class="fi-social-steam"></a>
                <a href="#" class="fi-social-xbox"></a>
                <a href="#" class="fi-social-reddit"></a> -->
                  <a href="https://plus.google.com/u/0/+PeterLawrey" class="fi-social-google-plus"></a>
                  <a href="https://github.com/peter-lawrey" class="fi-social-github"></a>
                  <a href="https://twitter.com/PeterLawrey" class="fi-social-twitter"></a>
            </div>
        </div>
    </div>
</header>

</div>


<div class="small-16 medium-16 large-12 columns main-column left">
    

<main class="content" role="main">

    <article class="post tag-Chronicle-Queue tag-Low-Latency">


            <h1 class="post-title">Improving percentile latencies in Chronicle Queue</h1>

            <span class="post-meta label"><time datetime="2017-02-06">06 Feb 2017</time></span>

            <section class="post-content">
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Compared to a year ago, we have significantly improved the throughput at which we can achieve the 99%ile (worst one in 100).
What tools and tricks did we use to achieve that?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_are_we_testing">What are we testing?</h3>
<div class="paragraph">
<p>Chronicle Queue appends messages to a file while another thread or process can be reading it.  This gives you persisted IPC (InterProcess Communication).</p>
</div>
<div class="paragraph">
<p>For our clients with higher expectations for latency, they are looking to have the whole service which is under 100 micro-seconds 99% of the time.</p>
</div>
<div class="paragraph">
<p>For our test, we have chosen to find the throughput you can achieve and still be under 10 micro-seconds 99% of the time. The test writes 20 million 40 bytes messages, which contains the time the message should have been sent to avoid co-ordinated omission, and read by another thread. The difference in time is recorded.</p>
</div>
<div class="paragraph">
<p>We have also added encryption support for our enterprise solution. We test here a salted AES 128-bit encryption.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_improvement">The improvement</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throughput where 99%ile is 10 microseconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">March 2016, unencrypted<br>
Centos 7 server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&nbsp;&nbsp;&nbsp;100 K/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">February 2017, encrypted<br>
Centos 7 server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&nbsp;&nbsp;&nbsp;700 K/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">February 2017, unencrypted<br>
Windows 10 Laptop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,200 K/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">February 2017, unencrypted<br>
Centos 7 server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2,400 K/s</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>What makes this improvement significant, is that we added correction for co-ordinated omission.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sampling_tool">Sampling tool</h3>
<div class="paragraph">
<p>While profilers are very useful, one thing they struggle with is helping you find the cause of latency outliers.  This is because profilers show you averages, and unless your outliers are really large, they don&#8217;t show up as significant.</p>
</div>
<div class="paragraph">
<p>To address this we added a class which acts as a basic stack sampler.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package net.openhft.chronicle.core.threads;

import java.util.concurrent.locks.LockSupport;

/**
 * Created by peter on 04/02/17.
 */
public class StackSampler {
    private final Thread sampler;
    private volatile Thread thread = null;
    private volatile StackTraceElement[] stack = null;

    public StackSampler() {
        sampler = new Thread(this::sampling, "Thread sampler");
        sampler.setDaemon(true);
        sampler.start();
    }

    void sampling() {
        while (!Thread.currentThread().isInterrupted()) {
            Thread t = thread;
            if (t != null) {
                StackTraceElement[] stack0 = t.getStackTrace();
                if (thread == t)
                    stack = stack0;
            }
            LockSupport.parkNanos(10_000);
        }
    }

    public void stop() {
        sampler.interrupt();
    }

    public void thread(Thread thread) {
        this.thread = thread;
    }

    public StackTraceElement[] getAndReset() {
        StackTraceElement[] stack = this.stack;
        thread = null;
        this.stack = null;
        return stack;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can accumulate the results in a <code>Map&lt;String, Integer&gt;</code> which is nothing special. Except we can filter only those which contributed to an outlier e.g. a delay of over 10 microseconds.</p>
</div>
<div class="paragraph">
<p>The results are pretty crude, however we found issues in code that the profile didn&#8217;t show.  The issue which came up again and again was <code>default</code> methods. As of Java 8 update 121, they just don&#8217;t seem to be optimised as well as methods in classes. We found that copying the default method to selected classes and only for the selected methods in this sampler, we saw a reduction in outliers which allowed us to increase the throughput further.</p>
</div>
<div class="paragraph">
<p>There were other optimisations more specific to our problem, but using class methods instead of default methods is a trick we have used before.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not all default methods are bad, we still use them often without a problem. Only override a default method for performance if you can show this helps.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_charting_the_99_ile_latency">Charting the 99%ile latency.</h3>
<div class="paragraph">
<p>For the unencrypted messages we achieve reasonable (less than 10 micro-seconds) latencies in the 99.9%ile up to 1.4 million messages per second and in the 99%ile up to 2.3 million per second.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/Vanilla-Java/vanilla-java.github.io/blob/master/images/latency-for-throughput.png?raw=true" alt="latency for throughput">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>It is possible to have low latency encrypted messages where the 99%ile is less than 10 microseconds, however we need to have a throughput of less than 700K messages per second (or use multiple threads / queues).</p>
</div>
<div class="paragraph">
<p>While minimising the latency of outliers is tricky, reducing the 99%ile latency can improve the consistency dramatically and increase the throughput you can safely sustain.</p>
</div>
</div>
                        <aside class="tags fi-pricetag-multiple">Posted on <a href="https://vanilla-java.github.io/tag/Chronicle-Queue/">Chronicle Queue</a>, <a href="https://vanilla-java.github.io/tag/Low-Latency/">Low Latency</a></aside>
            </section>
            <hr>
            <footer class="post-footer">

                <section class="share">
                    <h4>Liked this post ? Share it.</h4>
                    <a class="fi-social-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    </a>
                    <a class="fi-social-twitter" href="https://twitter.com/share?text=Improving%20percentile%20latencies%20in%20Chronicle%20Queue&amp;url=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    </a>
                    <a class="fi-social-google-plus" href="https://plus.google.com/share?url=https://vanilla-java.github.io/"
                       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    </a>
                </section>

                <section class="author">
                    <header>
                        <span>About the author</span>
                    </header>
                    <section>
                        <h4>Peter Lawrey</h4>
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4">
                        <span>London</span>
                        <a href="http://vanillajava.blogspot.com/">http://vanillajava.blogspot.com/</a>
                    </section>
                    <footer>
                         <p>Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion</p>
                    </footer>
                </section>

        <div class="clearfix"></div>
                    <hr>

            </footer>

        <h3 class="title-disqus"><span class="fi-comments"></span>Discussions</h3>




        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

</div>

</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

    <!--[if lte IE 8]>
        <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/outdatedBrowser.min.js?v=1536077024637"></script>
    <![endif]-->
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/min/built.js?v=1536077024637"></script>

    <script>
      $(document).foundation();
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
