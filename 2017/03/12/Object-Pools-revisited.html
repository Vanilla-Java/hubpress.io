<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Object Pools revisited</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/fastclick.js?v=1536077024549"></script>
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/modernizr.js?v=1536077024549"></script>


    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/normalize.css?v=1536077024549" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/foundation.min.css?v=1536077024549" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/outdatedBrowser.min.css?v=1536077024549">
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/fonts/foundation-icons/foundation-icons.css?v=1536077024549" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/styles.css?v=1536077024549" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300,700,400|Source+Sans+Pro:300,400,600,700,900,300italic,400italic,600italic,700italic,900italic" />

    <link rel="canonical" href="https://vanilla-java.github.io/2017/03/12/Object-Pools-revisited.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Object Pools revisited" />
    <meta property="og:description" content="Object pools were popular before Java 5.0 however more efficient allocation made most of these pools a needless complication. Can a Object Pool still make sense and how fast do they need to be? Overview Up to Java 5.0 using object pools could significantly improve performance.  However from" />
    <meta property="og:url" content="https://vanilla-java.github.io/2017/03/12/Object-Pools-revisited.html" />
    <meta property="article:published_time" content="2017-03-12T00:00:00.000Z" />
    <meta property="article:tag" content="Low Latency" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Object Pools revisited" />
    <meta name="twitter:description" content="Object pools were popular before Java 5.0 however more efficient allocation made most of these pools a needless complication. Can a Object Pool still make sense and how fast do they need to be? Overview Up to Java 5.0 using object pools could significantly improve performance.  However from" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2017/03/12/Object-Pools-revisited.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Object Pools revisited",
    "url": "https://vanilla-java.github.io/2017/03/12/Object-Pools-revisited.html",
    "datePublished": "2017-03-12T00:00:00.000Z",
    "keywords": "Low Latency",
    "description": "Object pools were popular before Java 5.0 however more efficient allocation made most of these pools a needless complication. Can a Object Pool still make sense and how fast do they need to be? Overview Up to Java 5.0 using object pools could significantly improve performance.  However from"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Low-Latency">

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdate" href="http://outdatedbrowser.com/">Update my browser now</a></p>
</div>

<nav class="top-bar hide-for-large-up" data-topbar style="background: none">
  <ul class="title-area">
    <li class="name">

    </li>
    <li class="home"><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
    <li class="toggle-topbar"><a href="#" id="trigger-overlay" class="fi-list"></a></li>
  </ul>

<div class="overlay overlay-scale">
    <button type="button" class="overlay-close">Close</button>
    <nav>
        <ul>
            <li><a href="https://vanilla-java.github.io">Home</a></li>
        </ul>
    </nav>
</div>

</nav>

<div class="row">

<div class="small-16 medium-16 large-4 columns right head-area bgimage" style="background-image: url(https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg)">

<header class="site-head">
    <div class="vertical">
        <div class="site-head-content inner">
            <ul class="side-nav blog-menu show-for-large-up">
                <li><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
                <li><a class="fi-torso" href="https://vanilla-java.github.io/about"></a></li>
                <li><a class="fi-mail" href="https://vanilla-java.github.io/contact"></a></li>
            </ul>
            <a class="blog-logo" href="https://vanilla-java.github.io"><img alt="Vanilla Java" src="https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg" alt="Blog Logo" /></a>
            <h1 class="blog-title">Vanilla Java</h1>
            <hr>
            <p class="blog-description"></p>
            <div class="blog-network">
<!--                 <a href="#" class="fi-social-pinterest"></a>
                <a href="#" class="fi-social-linkedin"></a>
                <a href="#" class="fi-social-behance"></a>
                <a href="#" class="fi-social-deviant-art"></a>
                <a href="#" class="fi-social-dribbble"></a>
                <a href="#" class="fi-social-flickr"></a>
                <a href="#" class="fi-social-github"></a>
                <a href="#" class="fi-social-skype"></a>
                <a href="#" class="fi-social-snapchat"></a>
                <a href="#" class="fi-social-steam"></a>
                <a href="#" class="fi-social-xbox"></a>
                <a href="#" class="fi-social-reddit"></a> -->
                  <a href="https://plus.google.com/u/0/+PeterLawrey" class="fi-social-google-plus"></a>
                  <a href="https://github.com/peter-lawrey" class="fi-social-github"></a>
                  <a href="https://twitter.com/PeterLawrey" class="fi-social-twitter"></a>
            </div>
        </div>
    </div>
</header>

</div>


<div class="small-16 medium-16 large-12 columns main-column left">
    

<main class="content" role="main">

    <article class="post tag-Low-Latency">


            <h1 class="post-title">Object Pools revisited</h1>

            <span class="post-meta label"><time datetime="2017-03-12">12 Mar 2017</time></span>

            <section class="post-content">
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Object pools were popular before Java 5.0 however more efficient allocation made most of these pools a needless complication. Can a Object Pool still make sense and how fast do they need to be?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_overview">Overview</h3>
<div class="paragraph">
<p>Up to Java 5.0 using object pools could significantly improve performance.  However from Java 5.0, the cost of using naive object pools was often worse (and more complicated) than just allocating new objects all the time.  However, if you work in a low latency environment and you want to keep allocations low, is there a way to make an object pool light weight enough to make sense.</p>
</div>
<div class="paragraph">
<p>A common use of a low level object is in the creation of Strings esp as input.  Whether you have a service reading data from the network, or loading data from a database or file, you are likely to use a lot of Strings. While there are tricks to avoid using Strings, most of the alternatives lead to unnatural Java code which is ugly and harder to maintain.  It would be much better if there was an efficient way to reuse Strings (assuming a high rate of duplication)</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_test">The test</h3>
<div class="paragraph">
<p>This test assume we have some data in native memory (from a TCP socket or a file), and we have the option to avoid copying the data into a byte[] before creating a String.</p>
</div>
<div class="paragraph">
<p>For different lengths of bytes (1, 2, 4, 8, 16, 32) we use JMH to benchmark how long it takes to provide a matching String.</p>
</div>
<div class="paragraph">
<p>"Object Pool" uses an object pool for the bytes converted into a String.</p>
</div>
<div class="paragraph">
<p>"new String US-ASCII" copies the data to a byte[] and uses US-ASCII encoding to create the String.</p>
</div>
<div class="paragraph">
<p>"new String hibyte=0" copies the data to a byte[] and uses a deprecated constructor to set the hi byte to 0 create the String.</p>
</div>
<div class="paragraph">
<p>The Source code is available here <a href="https://github.com/OpenHFT/Chronicle-Wire/blob/master/microbenchmarks/src/main/java/net/openhft/chronicle/wire/benchmarks/ObjectPoolMain.java">ObjectPoolMain.java</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_results">The results</h3>
<div class="paragraph">
<p>The average time to use the Object Pool was around 9 nano-seconds for short strings of up to 8 characters. About half the saving comes from avoiding the need to copy the data to a byte[] first. Also avoiding the use of even a trivial Charset character encoding also saved a significant amount.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/bytesToString.png" alt="bytesToString">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_use_an_object_pool_at_all">Why use an Object Pool at all?</h3>
<div class="paragraph">
<p>In this case the main reason is to avoid creating objects. If the String can be reused, it can dramatically reduce the garbage produced. Most of the time, only new Strings take space, rather than every String your use and this can be a 90% reduction in memory use and garbage production.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>For some use cases, an Object Pool is fast enough, possibly faster when it is has been optimised to minimise copies and supporting functions like character encoding.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The library used only supports ISO-8859-1 and UTF-8, so if you need another character encoding it would be significant work or use would have to use the standard functions.
</td>
</tr>
</table>
</div>
</div>
                        <aside class="tags fi-pricetag-multiple">Posted on <a href="https://vanilla-java.github.io/tag/Low-Latency/">Low Latency</a></aside>
            </section>
            <hr>
            <footer class="post-footer">

                <section class="share">
                    <h4>Liked this post ? Share it.</h4>
                    <a class="fi-social-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    </a>
                    <a class="fi-social-twitter" href="https://twitter.com/share?text=Object%20Pools%20revisited&amp;url=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    </a>
                    <a class="fi-social-google-plus" href="https://plus.google.com/share?url=https://vanilla-java.github.io/"
                       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    </a>
                </section>

                <section class="author">
                    <header>
                        <span>About the author</span>
                    </header>
                    <section>
                        <h4>Peter Lawrey</h4>
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4">
                        <span>London</span>
                        <a href="http://vanillajava.blogspot.com/">http://vanillajava.blogspot.com/</a>
                    </section>
                    <footer>
                         <p>Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion</p>
                    </footer>
                </section>

        <div class="clearfix"></div>
                    <hr>

            </footer>

        <h3 class="title-disqus"><span class="fi-comments"></span>Discussions</h3>




        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

</div>

</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

    <!--[if lte IE 8]>
        <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/outdatedBrowser.min.js?v=1536077024549"></script>
    <![endif]-->
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/min/built.js?v=1536077024549"></script>

    <script>
      $(document).foundation();
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
