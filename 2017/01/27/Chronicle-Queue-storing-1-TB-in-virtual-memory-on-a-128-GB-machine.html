<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Chronicle Queue storing 1 TB in virtual memory on a 128 GB machine</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://vanilla-java.github.io/favicon.ico">

    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/fastclick.js?v=1536077024667"></script>
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/vendor/modernizr.js?v=1536077024667"></script>


    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/normalize.css?v=1536077024667" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/foundation.min.css?v=1536077024667" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/outdatedBrowser.min.css?v=1536077024667">
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/fonts/foundation-icons/foundation-icons.css?v=1536077024667" />
    <link rel="stylesheet" type="text/css" href="//vanilla-java.github.io/themes/ichi/assets/css/styles.css?v=1536077024667" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300,700,400|Source+Sans+Pro:300,400,600,700,900,300italic,400italic,600italic,700italic,900italic" />

    <link rel="canonical" href="https://vanilla-java.github.io/2017/01/27/Chronicle-Queue-storing-1-TB-in-virtual-memory-on-a-128-GB-machine.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Vanilla Java" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Chronicle Queue storing 1 TB in virtual memory on a 128 GB machine" />
    <meta property="og:description" content="If you use a standard JVM like the Oracle JVM, or the OpenJDK, you might find that as the heap size grows the performance of your JVM can drop as GC pause time escalates.  This tends to be a problem around 32 GB of heap, but it often depends on" />
    <meta property="og:url" content="https://vanilla-java.github.io/2017/01/27/Chronicle-Queue-storing-1-TB-in-virtual-memory-on-a-128-GB-machine.html" />
    <meta property="article:published_time" content="2017-01-27T00:00:00.000Z" />
    <meta property="article:tag" content="Chronicle Queue" />
    <meta property="article:tag" content="Off Heap" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Chronicle Queue storing 1 TB in virtual memory on a 128 GB machine" />
    <meta name="twitter:description" content="If you use a standard JVM like the Oracle JVM, or the OpenJDK, you might find that as the heap size grows the performance of your JVM can drop as GC pause time escalates.  This tends to be a problem around 32 GB of heap, but it often depends on" />
    <meta name="twitter:url" content="https://vanilla-java.github.io/2017/01/27/Chronicle-Queue-storing-1-TB-in-virtual-memory-on-a-128-GB-machine.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Vanilla Java",
    "author": {
        "@type": "Person",
        "name": "Peter Lawrey",
        "image": "https://avatars0.githubusercontent.com/u/1070321?v=4",
        "url": "https://vanilla-java.github.io/author/peter-lawrey/",
        "sameAs": "http://vanillajava.blogspot.com/",
        "description": "Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion"
    },
    "headline": "Chronicle Queue storing 1 TB in virtual memory on a 128 GB machine",
    "url": "https://vanilla-java.github.io/2017/01/27/Chronicle-Queue-storing-1-TB-in-virtual-memory-on-a-128-GB-machine.html",
    "datePublished": "2017-01-27T00:00:00.000Z",
    "keywords": "Chronicle Queue, Off Heap",
    "description": "If you use a standard JVM like the Oracle JVM, or the OpenJDK, you might find that as the heap size grows the performance of your JVM can drop as GC pause time escalates.  This tends to be a problem around 32 GB of heap, but it often depends on"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Vanilla Java" href="https://vanilla-java.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Chronicle-Queue tag-Off-Heap">

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdate" href="http://outdatedbrowser.com/">Update my browser now</a></p>
</div>

<nav class="top-bar hide-for-large-up" data-topbar style="background: none">
  <ul class="title-area">
    <li class="name">

    </li>
    <li class="home"><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
    <li class="toggle-topbar"><a href="#" id="trigger-overlay" class="fi-list"></a></li>
  </ul>

<div class="overlay overlay-scale">
    <button type="button" class="overlay-close">Close</button>
    <nav>
        <ul>
            <li><a href="https://vanilla-java.github.io">Home</a></li>
        </ul>
    </nav>
</div>

</nav>

<div class="row">

<div class="small-16 medium-16 large-4 columns right head-area bgimage" style="background-image: url(https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg)">

<header class="site-head">
    <div class="vertical">
        <div class="site-head-content inner">
            <ul class="side-nav blog-menu show-for-large-up">
                <li><a class="fi-home" href="https://vanilla-java.github.io"></a></li>
                <li><a class="fi-torso" href="https://vanilla-java.github.io/about"></a></li>
                <li><a class="fi-mail" href="https://vanilla-java.github.io/contact"></a></li>
            </ul>
            <a class="blog-logo" href="https://vanilla-java.github.io"><img alt="Vanilla Java" src="https://raw.githubusercontent.com/Vanilla-Java/vanilla-java.github.io/master/images/French-Vanilla-Java.jpg" alt="Blog Logo" /></a>
            <h1 class="blog-title">Vanilla Java</h1>
            <hr>
            <p class="blog-description"></p>
            <div class="blog-network">
<!--                 <a href="#" class="fi-social-pinterest"></a>
                <a href="#" class="fi-social-linkedin"></a>
                <a href="#" class="fi-social-behance"></a>
                <a href="#" class="fi-social-deviant-art"></a>
                <a href="#" class="fi-social-dribbble"></a>
                <a href="#" class="fi-social-flickr"></a>
                <a href="#" class="fi-social-github"></a>
                <a href="#" class="fi-social-skype"></a>
                <a href="#" class="fi-social-snapchat"></a>
                <a href="#" class="fi-social-steam"></a>
                <a href="#" class="fi-social-xbox"></a>
                <a href="#" class="fi-social-reddit"></a> -->
                  <a href="https://plus.google.com/u/0/+PeterLawrey" class="fi-social-google-plus"></a>
                  <a href="https://github.com/peter-lawrey" class="fi-social-github"></a>
                  <a href="https://twitter.com/PeterLawrey" class="fi-social-twitter"></a>
            </div>
        </div>
    </div>
</header>

</div>


<div class="small-16 medium-16 large-12 columns main-column left">
    

<main class="content" role="main">

    <article class="post tag-Chronicle-Queue tag-Off-Heap">


            <h1 class="post-title">Chronicle Queue storing 1 TB in virtual memory on a 128 GB machine</h1>

            <span class="post-meta label"><time datetime="2017-01-27">27 Jan 2017</time></span>

            <section class="post-content">
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>If you use a standard JVM like the Oracle JVM, or the OpenJDK, you might find that as the heap size grows the performance of your JVM can drop as GC pause time escalates.  This tends to be a problem around 32 GB of heap, but it often depends on the application at which point the size of you heap becomes a problem.</p>
</div>
<div class="paragraph">
<p>One way around this is to use an always concurrent collector such as <a href="https://www.azul.com/products/zing/">Azul Zing</a> which is designed to both scale to much larger heap sizes and even reduce the GC pause times for smaller heap consistently.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_set_larger_than_main_memory">Data set larger than main memory?</h3>
<div class="paragraph">
<p>What if your data set sizes are larger than main memory?  At this point using the heap doesn&#8217;t scale and you need a data store off heap. This could be a database, NoSQL, but these can be dramatically slower depending on what you are doing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_chronicle_supports_a_huge_persisted_dataset">Chronicle supports a huge, persisted dataset.</h3>
<div class="paragraph">
<p>Chronicle Queue and Chronicle Map allows you to have a persisted store which can be embedded into multiple JVMs on the same server.  How does it perform when you exceed main memory size.  In this page, we look at Chronicle Queue with favouring for sequential access, scales very well, and shows a little slow down.</p>
</div>
<div class="paragraph">
<p>What does a JVM which is over 1 TB in virtualsize look like?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/JVM-1TB.png" alt="JVM 1TB">
</div>
<div class="title">Figure 1. top on a machine with 128 GB of memory, and a JVM with 1 TB of queue data</div>
</div>
<div class="paragraph">
<p>In this example, the JVM with 1 TB of data reports that 0.111t or 111 G is in memory, though the virtual size is 1.281t or 1,281 GB (with heaps and indexes)</p>
</div>
</div>
<div class="sect2">
<h3 id="_but_how_does_it_perform_it_must_get_slower">But how does it perform? It must get slower.</h3>
<div class="paragraph">
<p>If you attempted to create and use a 1 TB heap on a machine with 128 GB of memory, it would either fail to start, or with some tuning, start but make your machine unusable.  How much does using Chronicle Queue to store the data slow down?</p>
</div>
<div class="paragraph">
<p>In this test, it writes a bursts of 2 million 512 bytes messsage (1024^3 bytes of data), it then reads the data and waits 8 seconds to let the disk catch up. While the burst rate is about 1 GB/s, the underlying disk doesn&#8217;t have the write speed and for this test it averages about 100 MB/s.  It takes about 2.5 hours to write 1 TB.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/read-time-1gb.png" alt="read time 1gb">
</div>
<div class="title">Figure 2. The read time is fairly consistent for this test</div>
</div>
<div class="paragraph">
<p>We would expect reads to be consistent as we are always reading something we just wrote.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While the machine has 128 GB of memory, it has two NUMA regions of 64 GB.  This shows around 64 GB has been written.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The write performance is more dramatic.  There is also significant variation as it has to find new memory to write to.  This can be mitigated by using a pretouch() call to pre-allocate memory to write to.  Normally, this would be run in a background thread, but for the purposes of this test it was run in the same thread but not timed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://vanilla-java.github.io/images/write-time-1gb.png" alt="write time 1gb">
</div>
<div class="title">Figure 3. The write time is fairly consistent beyond 192 GB</div>
</div>
<div class="paragraph">
<p>The average time to write a GB for the first 64 GB was 885 ms.  From 256 GB in size this takes an average of 1,084 ms which is an increase of 22%.</p>
</div>
<div class="paragraph">
<p>However, let us consider that the alternative is to pump 2 million records (1 GB) of data to a database, and query it to get the data back. By having it in the JVM, we can read 2 million record in as little as 200 ms using just one thread.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>Chronicle Queue performs very well up to the limit of main memory and beyond. It uses very little heap and has only a notional impact on GC pause times even if the dat set size is many times main memory.</p>
</div>
<div class="paragraph">
<p>You can try this test yourself here <a href="https://github.com/OpenHFT/Chronicle-Queue/blob/master/src/test/java/net/openhft/chronicle/queue/RunLargeQueueMain.java">RunLargeQueueMain</a></p>
</div>
<div class="paragraph">
<p>For more information on Chronicle Queue <a href="https://github.com/OpenHFT/Chronicle-Queue">GitHub source</a> <a href="http://chronicle.software/products/chronicle-queue/">Chronicle Queue Product page</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Having a queue larger than main memory only works on Unix at the moment. On Windows, a cycle e.g. a day, has to fit into main memory.  This is something we would like to fix in the future.
</td>
</tr>
</table>
</div>
</div>
                        <aside class="tags fi-pricetag-multiple">Posted on <a href="https://vanilla-java.github.io/tag/Chronicle-Queue/">Chronicle Queue</a>, <a href="https://vanilla-java.github.io/tag/Off-Heap/">Off Heap</a></aside>
            </section>
            <hr>
            <footer class="post-footer">

                <section class="share">
                    <h4>Liked this post ? Share it.</h4>
                    <a class="fi-social-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    </a>
                    <a class="fi-social-twitter" href="https://twitter.com/share?text=Chronicle%20Queue%20storing%201%20TB%20in%20virtual%20memory%20on%20a%20128%20GB%20machine&amp;url=https://vanilla-java.github.io/"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    </a>
                    <a class="fi-social-google-plus" href="https://plus.google.com/share?url=https://vanilla-java.github.io/"
                       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    </a>
                </section>

                <section class="author">
                    <header>
                        <span>About the author</span>
                    </header>
                    <section>
                        <h4>Peter Lawrey</h4>
                        <img src="https://avatars0.githubusercontent.com/u/1070321?v&#x3D;4">
                        <span>London</span>
                        <a href="http://vanillajava.blogspot.com/">http://vanillajava.blogspot.com/</a>
                    </section>
                    <footer>
                         <p>Most answers for Java and JVM on StackOverflow.com (~13K), &quot;Vanilla Java&quot; blog with four million views, founder of the Performance JUG,  Java Champion</p>
                    </footer>
                </section>

        <div class="clearfix"></div>
                    <hr>

            </footer>

        <h3 class="title-disqus"><span class="fi-comments"></span>Discussions</h3>




        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'vanillajava'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

</div>

</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

    <!--[if lte IE 8]>
        <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/outdatedBrowser.min.js?v=1536077024667"></script>
    <![endif]-->
    <script type="text/javascript" src="//vanilla-java.github.io/themes/ichi/assets/js/min/built.js?v=1536077024667"></script>

    <script>
      $(document).foundation();
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81039510-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
